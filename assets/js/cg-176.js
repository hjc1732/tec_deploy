(window.webpackJsonp=window.webpackJsonp||[]).push([[176],{1438:function(s,e,r){"use strict";r.r(e);var t=r(7),a=Object(t.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"消息轨迹"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#消息轨迹"}},[s._v("#")]),s._v(" 消息轨迹")]),s._v(" "),e("h2",{attrs:{id:"_1-消息轨迹数据关键属性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-消息轨迹数据关键属性"}},[s._v("#")]),s._v(" 1. 消息轨迹数据关键属性")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("Producer端")]),s._v(" "),e("th",[s._v("Consumer端")]),s._v(" "),e("th",[s._v("Broker端")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("生产实例信息")]),s._v(" "),e("td",[s._v("消费实例信息")]),s._v(" "),e("td",[s._v("消息的Topic")])]),s._v(" "),e("tr",[e("td",[s._v("发送消息时间")]),s._v(" "),e("td",[s._v("投递时间,投递轮次")]),s._v(" "),e("td",[s._v("消息存储位置")])]),s._v(" "),e("tr",[e("td",[s._v("消息是否发送成功")]),s._v(" "),e("td",[s._v("消息是否消费成功")]),s._v(" "),e("td",[s._v("消息的Key值")])]),s._v(" "),e("tr",[e("td",[s._v("发送耗时")]),s._v(" "),e("td",[s._v("消费耗时")]),s._v(" "),e("td",[s._v("消息的Tag值")])])])]),s._v(" "),e("h2",{attrs:{id:"_2-支持消息轨迹集群部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-支持消息轨迹集群部署"}},[s._v("#")]),s._v(" 2. 支持消息轨迹集群部署")]),s._v(" "),e("h3",{attrs:{id:"_2-1-broker端配置文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-broker端配置文件"}},[s._v("#")]),s._v(" 2.1 Broker端配置文件")]),s._v(" "),e("p",[s._v("这里贴出Broker端开启消息轨迹特性的properties配置文件内容：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("brokerClusterName=DefaultCluster\nbrokerName=broker-a\nbrokerId=0\ndeleteWhen=04\nfileReservedTime=48\nbrokerRole=ASYNC_MASTER\nflushDiskType=ASYNC_FLUSH\nstorePathRootDir=/data/rocketmq/rootdir-a-m\nstorePathCommitLog=/data/rocketmq/commitlog-a-m\nautoCreateSubscriptionGroup=true\n## if msg tracing is open,the flag will be true\ntraceTopicEnable=true\nlistenPort=10911\nbrokerIP1=XX.XX.XX.XX1\nnamesrvAddr=XX.XX.XX.XX:9876\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h3",{attrs:{id:"_2-2-普通模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-普通模式"}},[s._v("#")]),s._v(" 2.2 普通模式")]),s._v(" "),e("p",[s._v("RocketMQ集群中每一个Broker节点均用于存储Client端收集并发送过来的消息轨迹数据。因此，对于RocketMQ集群中的Broker节点数量并无要求和限制。")]),s._v(" "),e("h3",{attrs:{id:"_2-3-物理io隔离模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-物理io隔离模式"}},[s._v("#")]),s._v(" 2.3 物理IO隔离模式")]),s._v(" "),e("p",[s._v("对于消息轨迹数据量较大的场景，可以在RocketMQ集群中选择其中一个Broker节点专用于存储消息轨迹，使得用户普通的消息数据与消息轨迹数据的物理IO完全隔离，互不影响。在该模式下，RockeMQ集群中至少有两个Broker节点，其中一个Broker节点定义为存储消息轨迹数据的服务端。")]),s._v(" "),e("h3",{attrs:{id:"_2-4-启动开启消息轨迹的broker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-启动开启消息轨迹的broker"}},[s._v("#")]),s._v(" 2.4 启动开启消息轨迹的Broker")]),s._v(" "),e("p",[e("code",[s._v("nohup sh mqbroker -c ../conf/2m-noslave/broker-a.properties &")])]),s._v(" "),e("h2",{attrs:{id:"_3-保存消息轨迹的topic定义"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-保存消息轨迹的topic定义"}},[s._v("#")]),s._v(" 3. 保存消息轨迹的Topic定义")]),s._v(" "),e("p",[s._v("RocketMQ的消息轨迹特性支持两种存储轨迹数据的方式：")]),s._v(" "),e("h3",{attrs:{id:"_3-1-系统级的tracetopic"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-系统级的tracetopic"}},[s._v("#")]),s._v(" 3.1 系统级的TraceTopic")]),s._v(" "),e("p",[s._v("在默认情况下，消息轨迹数据是存储于系统级的TraceTopic中(其名称为："),e("strong",[s._v("RMQ_SYS_TRACE_TOPIC")]),s._v(")。该Topic在Broker节点启动时，会自动创建出来（如上所叙，需要在Broker端的配置文件中将"),e("strong",[s._v("traceTopicEnable")]),s._v("的开关变量设置为"),e("strong",[s._v("true")]),s._v("）。")]),s._v(" "),e("h3",{attrs:{id:"_3-2-用户自定义的tracetopic"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-用户自定义的tracetopic"}},[s._v("#")]),s._v(" 3.2 用户自定义的TraceTopic")]),s._v(" "),e("p",[s._v("如果用户不准备将消息轨迹的数据存储于系统级的默认TraceTopic，也可以自己定义并创建用户级的Topic来保存轨迹（即为创建普通的Topic用于保存消息轨迹数据）。下面一节会介绍Client客户端的接口如何支持用户自定义的TraceTopic。")]),s._v(" "),e("h2",{attrs:{id:"_4-支持消息轨迹的client客户端实践"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-支持消息轨迹的client客户端实践"}},[s._v("#")]),s._v(" 4. 支持消息轨迹的Client客户端实践")]),s._v(" "),e("p",[s._v("为了尽可能地减少用户业务系统使用RocketMQ消息轨迹特性的改造工作量，作者在设计时候采用对原来接口增加一个开关参数("),e("strong",[s._v("enableMsgTrace")]),s._v(")来实现消息轨迹是否开启；并新增一个自定义参("),e("strong",[s._v("customizedTraceTopic")]),s._v(")数来实现用户存储消息轨迹数据至自己创建的用户级Topic。")]),s._v(" "),e("h3",{attrs:{id:"_4-1-发送消息时开启消息轨迹"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-发送消息时开启消息轨迹"}},[s._v("#")]),s._v(" 4.1 发送消息时开启消息轨迹")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('        DefaultMQProducer producer = new DefaultMQProducer("ProducerGroupName",true);\n        producer.setNamesrvAddr("XX.XX.XX.XX1");\n        producer.start();\n            try {\n                {\n                    Message msg = new Message("TopicTest",\n                        "TagA",\n                        "OrderID188",\n                        "Hello world".getBytes(RemotingHelper.DEFAULT_CHARSET));\n                    SendResult sendResult = producer.send(msg);\n                    System.out.printf("%s%n", sendResult);\n                }\n\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("h3",{attrs:{id:"_4-2-订阅消息时开启消息轨迹"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-订阅消息时开启消息轨迹"}},[s._v("#")]),s._v(" 4.2 订阅消息时开启消息轨迹")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("CID_JODIE_1",true);\n        consumer.subscribe("TopicTest", "*");\n        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);\n        consumer.setConsumeTimestamp("20181109221800");\n        consumer.registerMessageListener(new MessageListenerConcurrently() {\n            @Override\n            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {\n                System.out.printf("%s Receive New Messages: %s %n", Thread.currentThread().getName(), msgs);\n                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;\n            }\n        });\n        consumer.start();\n        System.out.printf("Consumer Started.%n");\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h3",{attrs:{id:"_4-3-支持自定义存储消息轨迹topic"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-支持自定义存储消息轨迹topic"}},[s._v("#")]),s._v(" 4.3 支持自定义存储消息轨迹Topic")]),s._v(" "),e("p",[s._v("在上面的发送和订阅消息时候分别将DefaultMQProducer和DefaultMQPushConsumer实例的初始化修改为如下即可支持自定义存储消息轨迹Topic。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('        ##其中Topic_test11111需要用户自己预先创建，来保存消息轨迹；\n        DefaultMQProducer producer = new DefaultMQProducer("ProducerGroupName",true,"Topic_test11111");\n        ......\n\n        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("CID_JODIE_1",true,"Topic_test11111");\n        ......\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])])])}),[],!1,null,null,null);e.default=a.exports}}]);