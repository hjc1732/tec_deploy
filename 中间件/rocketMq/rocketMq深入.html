<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RocketMQ深入理解 | 技术侦探</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script charset="utf-8" async="async" src="https://s9.cnzz.com/z_stat.php?id=1278232949&amp;web_id=1278232949"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?0b31b4c146bf7126aed5009e1a4a11c8";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="技术并不是我们所追求的目的,而是技术创新世界">
    <meta property="article:modified_time" content="null">
    <meta property="og:title" content="RocketMQ深入理解">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html">
    <meta name="twitter:title" content="RocketMQ深入理解">
    <meta name="twitter:url" content="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="小傅哥">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="Java基础">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.ee4e0787.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1720663609756" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1720663609756" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1720663609756" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1720663609756" as="script"><link rel="preload" href="/assets/js/cg-13.js?v=1720663609756" as="script"><link rel="preload" href="/assets/js/cg-1.js?v=1720663609756" as="script"><link rel="preload" href="/assets/js/cg-92.js?v=1720663609756" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.ee4e0787.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1720663609756">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">技术侦探</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/javaSE基础/01_Java入门与开发环境搭建.html" class="nav-link">
  javaSE
</a></li><li class="dropdown-subitem"><a href="/java/javaWeb/01_Web开发基础.html" class="nav-link">
  javaWeb
</a></li><li class="dropdown-subitem"><a href="/java/JUC/1、JUC概述.html" class="nav-link">
  JUC
</a></li><li class="dropdown-subitem"><a href="/java/响应式编程/前置知识.html" class="nav-link">
  响应式编程
</a></li><li class="dropdown-subitem"><a href="/设计模式/概述/概述.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-subitem"><a href="/java/日志/1_日志简介.html" class="nav-link">
  日志
</a></li></ul></li><li class="dropdown-item"><h4>
          数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/db/jdbc/01_JDBC.html" class="nav-link">
  jdbc
</a></li><li class="dropdown-subitem"><a href="/db/mysql/Mysql基础/01_MySQL概述.html" class="nav-link">
  mysql
</a></li></ul></li><li class="dropdown-item"><h4>
          补充
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/补充/Retrofit2.html" class="nav-link">
  Retrofit2
</a></li><li class="dropdown-subitem"><a href="/java/补充/rxJava/rxJava.html" class="nav-link">
  rxJava
</a></li><li class="dropdown-subitem"><a href="/java/补充/lua.html" class="nav-link">
  lua
</a></li><li class="dropdown-subitem"><a href="/java/补充/JVM.html" class="nav-link">
  jvm
</a></li><li class="dropdown-subitem"><a href="/java/补充/枚举.html" class="nav-link">
  枚举
</a></li><li class="dropdown-subitem"><a href="/java/补充/线程池.html" class="nav-link">
  线程池
</a></li><li class="dropdown-subitem"><a href="/java/补充/自定义注解.html" class="nav-link">
  自定义注解
</a></li></ul></li><li class="dropdown-item"><h4>
          前端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/前端/前端基础/01_HTML.html" class="nav-link">
  前端基础
</a></li><li class="dropdown-subitem"><a href="/前端/vue/01_ECMAScript6入门.html" class="nav-link">
  vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          架构
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/框架/架构/项目搭建/项目搭建.html" class="nav-link">
  项目搭建
</a></li><li class="dropdown-subitem"><a href="/框架/架构/DDD架构/01-ddd是什么.html" class="nav-link">
  DDD
</a></li></ul></li><li class="dropdown-item"><h4>
          ORM
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/框架/Mybatis/01_MyBatis快速入门.html" class="nav-link">
  Mybatis
</a></li></ul></li><li class="dropdown-item"><h4>
          Spring全家桶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/框架/Spring全家桶/Spring/01_SpringIOC和DI.html" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/框架/Spring全家桶/SpringMVC/01_SpringMVC快速入门及解析.html" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-subitem"><a href="/框架/Spring全家桶/SpringBoot/01_SpringBoot_入门.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-subitem"><a href="/框架/Spring全家桶/SpringSecurity/SpringSecurity.html" class="nav-link">
  SpringSecurity
</a></li><li class="dropdown-subitem"><a href="/框架/Spring全家桶/SpringCloudAlibaba/Nacos.html" class="nav-link">
  SpringCloudAlibaba
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/中间件/ElasticSearch/ElasticSearch.html" class="nav-link">
  中间件 | 自研轮子
</a></div><div class="nav-item"><a href="/部署/linux/01_Linux_安装.html" class="nav-link">
  部署|运维
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目练手" class="dropdown-title"><span class="title">项目练手</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://cj.hjcwzx.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  营销抽奖
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://520.hjcwzx.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  研究生工作平台
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/实战/实用工具类/DocUtils.html" class="nav-link">
  实用工具类
</a></li><li class="dropdown-item"><!----> <a href="/实战/商城/项目笔记.html" class="nav-link">
  锋迷铺子
</a></li></ul></div></div><div class="nav-item"><a href="https://www.hjcwzx.top/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网站迁移
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/更新日志/更新日志.html" class="nav-link">
  更新日志
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/javaSE基础/01_Java入门与开发环境搭建.html" class="nav-link">
  javaSE
</a></li><li class="dropdown-subitem"><a href="/java/javaWeb/01_Web开发基础.html" class="nav-link">
  javaWeb
</a></li><li class="dropdown-subitem"><a href="/java/JUC/1、JUC概述.html" class="nav-link">
  JUC
</a></li><li class="dropdown-subitem"><a href="/java/响应式编程/前置知识.html" class="nav-link">
  响应式编程
</a></li><li class="dropdown-subitem"><a href="/设计模式/概述/概述.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-subitem"><a href="/java/日志/1_日志简介.html" class="nav-link">
  日志
</a></li></ul></li><li class="dropdown-item"><h4>
          数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/db/jdbc/01_JDBC.html" class="nav-link">
  jdbc
</a></li><li class="dropdown-subitem"><a href="/db/mysql/Mysql基础/01_MySQL概述.html" class="nav-link">
  mysql
</a></li></ul></li><li class="dropdown-item"><h4>
          补充
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/补充/Retrofit2.html" class="nav-link">
  Retrofit2
</a></li><li class="dropdown-subitem"><a href="/java/补充/rxJava/rxJava.html" class="nav-link">
  rxJava
</a></li><li class="dropdown-subitem"><a href="/java/补充/lua.html" class="nav-link">
  lua
</a></li><li class="dropdown-subitem"><a href="/java/补充/JVM.html" class="nav-link">
  jvm
</a></li><li class="dropdown-subitem"><a href="/java/补充/枚举.html" class="nav-link">
  枚举
</a></li><li class="dropdown-subitem"><a href="/java/补充/线程池.html" class="nav-link">
  线程池
</a></li><li class="dropdown-subitem"><a href="/java/补充/自定义注解.html" class="nav-link">
  自定义注解
</a></li></ul></li><li class="dropdown-item"><h4>
          前端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/前端/前端基础/01_HTML.html" class="nav-link">
  前端基础
</a></li><li class="dropdown-subitem"><a href="/前端/vue/01_ECMAScript6入门.html" class="nav-link">
  vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          架构
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/框架/架构/项目搭建/项目搭建.html" class="nav-link">
  项目搭建
</a></li><li class="dropdown-subitem"><a href="/框架/架构/DDD架构/01-ddd是什么.html" class="nav-link">
  DDD
</a></li></ul></li><li class="dropdown-item"><h4>
          ORM
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/框架/Mybatis/01_MyBatis快速入门.html" class="nav-link">
  Mybatis
</a></li></ul></li><li class="dropdown-item"><h4>
          Spring全家桶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/框架/Spring全家桶/Spring/01_SpringIOC和DI.html" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/框架/Spring全家桶/SpringMVC/01_SpringMVC快速入门及解析.html" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-subitem"><a href="/框架/Spring全家桶/SpringBoot/01_SpringBoot_入门.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-subitem"><a href="/框架/Spring全家桶/SpringSecurity/SpringSecurity.html" class="nav-link">
  SpringSecurity
</a></li><li class="dropdown-subitem"><a href="/框架/Spring全家桶/SpringCloudAlibaba/Nacos.html" class="nav-link">
  SpringCloudAlibaba
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/中间件/ElasticSearch/ElasticSearch.html" class="nav-link">
  中间件 | 自研轮子
</a></div><div class="nav-item"><a href="/部署/linux/01_Linux_安装.html" class="nav-link">
  部署|运维
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目练手" class="dropdown-title"><span class="title">项目练手</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://cj.hjcwzx.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  营销抽奖
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://520.hjcwzx.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  研究生工作平台
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/实战/实用工具类/DocUtils.html" class="nav-link">
  实用工具类
</a></li><li class="dropdown-item"><!----> <a href="/实战/商城/项目笔记.html" class="nav-link">
  锋迷铺子
</a></li></ul></div></div><div class="nav-item"><a href="https://www.hjcwzx.top/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网站迁移
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/更新日志/更新日志.html" class="nav-link">
  更新日志
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>中间件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/中间件/ElasticSearch/ElasticSearch.html" class="sidebar-link">Elasticsearch</a></li><li><a href="/中间件/EasyES/Easy-es.html" class="sidebar-link">Easy-Es</a></li><li><a href="/中间件/ELK/使用docker搭建ELK.html" class="sidebar-link">ELK搭建(Docker版本)</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/中间件/redis/Redis笔记全.html" class="sidebar-link">Redis</a></li><li><a href="/中间件/redis/布隆过滤器.html" class="sidebar-link">布隆过滤器</a></li><li><a href="/中间件/redis/redisson.html" class="sidebar-link">Redisson</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>RocketMQ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/中间件/rocketMq/RocketMQ.html" class="sidebar-link">RocketMQ入门</a></li><li><a href="/中间件/rocketMq/rocketMq深入.html" class="active sidebar-link">RocketMQ深入理解</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>官方文档</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><a href="/中间件/git/笔记.html" class="sidebar-link">Git</a></li><li><a href="/中间件/maven/01_Maven基础.html" class="sidebar-link">Maven基础</a></li><li><a href="/中间件/maven/02_Maven聚合工程.html" class="sidebar-link">Maven聚合工程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>自定义starter</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/中间件/自定义Starter/自定义starter.html" class="sidebar-link">自定义starter</a></li><li><a href="/中间件/自定义Starter/白名单过滤starter.html" class="sidebar-link">白名单过滤</a></li><li><a href="/中间件/自定义Starter/上传中央仓库.html" class="sidebar-link">上传maven中央仓库</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="rocketmq深入理解"><a href="#rocketmq深入理解" class="header-anchor">#</a> RocketMQ深入理解</h1> <h2 id="主要内容"><a href="#主要内容" class="header-anchor">#</a> 主要内容</h2> <ol><li><p>RocketMQ简介</p></li> <li><p>RocketMQ概念</p></li> <li><p>RocketMQ安装</p></li> <li><p>RocketMQ快速入门</p></li> <li><p>RocketMQ消息模式</p></li> <li><p>RocketMQ重试机制</p></li> <li><p>RocketMQ重复消费问题</p></li> <li><p>RocketMQ集成SpringBoot</p></li></ol> <h2 id="_1-rocketmq简介"><a href="#_1-rocketmq简介" class="header-anchor">#</a> 1 RocketMQ简介</h2> <p>MQ====Message Queue</p> <p>官网：<a href="http://rocketmq.apache.org/" target="_blank" rel="noopener noreferrer">http://rocketmq.apache.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/assets/img/image3.5b005ea8.png" alt=""></p> <p>RocketMQ是阿里巴巴2016年MQ中间件，使用Java语言开发，RocketMQ
是一款开源的<strong>分布式消息系统</strong>，基于高可用分布式集群技术，提供低延时的、高可靠的消息发布与订阅服务。同时，广泛应用于多个领域，包括异步通信解耦、企业解决方案、金融支付、电信、电子商务、快递物流、广告营销、社交、即时通信、移动应用、手游、视频、物联网、车联网等。</p> <p>具有以下特点：</p> <ol><li><p>能够保证严格的消息顺序</p></li> <li><p>提供丰富的消息拉取模式</p></li> <li><p>高效的订阅者水平扩展能力</p></li> <li><p>实时的消息订阅机制</p></li> <li><p>亿级消息堆积能力</p></li></ol> <h2 id="_2-为什么要使用mq"><a href="#_2-为什么要使用mq" class="header-anchor">#</a> 2 为什么要使用MQ</h2> <p>1，要做到系统解耦，当新的模块进来时，可以做到代码改动最小;  <strong>能够解耦</strong></p> <p>2，设置流程缓冲池，可以让后端系统按自身<strong>吞吐</strong>能力进行消费，不被冲垮; <strong>能够削峰，限流</strong></p> <p>3，强弱依赖梳理能把非关键调用链路的操作异步化并提升整体系统的吞吐能力;<strong>能够异步</strong></p> <p><strong>[Mq的作用 削峰限流 异步 解耦合]{.mark}</strong></p> <h3 id="_2-1-定义"><a href="#_2-1-定义" class="header-anchor">#</a> 2.1 定义</h3> <p>中间件（缓存中间件 redis memcache 数据库中间件 mycat canal 消息中间件mq）</p> <p>面向消息的<strong>中间件</strong>(message-oriented middleware)
MOM能够很好的解决以上的问题。</p> <p>是指利用<strong>高效可靠的消息传递机制进行与平台无关（跨平台）的数据交流</strong>，并基于数据通信来进行分布式系统的集成。</p> <p>通过提供<strong>消息传递和消息排队模型</strong>在分布式环境下提供应用解耦，弹性伸缩，冗余存储，流量削峰，异步通信，数据同步等</p> <p>大致流程</p> <p>发送者把消息发给消息服务器[MQ]，消息服务器把消息存放在若干<strong>队列</strong>/<strong>主题</strong>中，在合适的时候，消息服务器会把消息转发给接受者。在这个过程中，发送和接受是异步的,也就是发送无需等待，发送者和接受者的生命周期也没有必然关系在发布pub/订阅sub模式下，也可以完成一对多的通信，可以让一个消息有多个接受者[微信订阅号就是这样的]</p> <p><img src="/assets/img/image4.1901581a.png" alt=""></p> <h3 id="_2-2-特点"><a href="#_2-2-特点" class="header-anchor">#</a> 2.2 特点</h3> <h4 id="_2-2-1-异步处理模式"><a href="#_2-2-1-异步处理模式" class="header-anchor">#</a> 2.2.1 异步处理模式</h4> <p>消息发送者可以发送一个消息而无需等待响应。消息发送者把消息发送到一条虚拟的通道(主题或队列)上;</p> <p>消息接收者则订阅或监听该通道。一条信息可能最终转发给一个或多个消息接收者，这些接收者都无需对消息发送者做出回应。整个过程都是异步的。</p> <p>案例：</p> <p>也就是说，一个系统和另一个系统间进行通信的时候，假如系统A希望发送一个消息给系统B，让它去处理，但是系统A不关注系统B到底怎么处理或者有没有处理好，所以系统A把消息发送给MQ，然后就不管这条消息的&quot;死活&quot;
了，接着系统B从MQ里面消费出来处理即可。至于怎么处理，是否处理完毕，什么时候处理，都是系统B的事，与系统A无关。</p> <p><img src="/assets/img/image5.d38c080b.png" alt=""></p> <p>这样的一种通信方式，就是所谓的&quot;异步&quot;通信方式，对于系统A来说，只要把消息发给MQ,然后系统B就会异步处去进行处理了，系统A不能&quot;同步&quot;的等待系统B处理完。这样的好处是什么呢？解耦</p> <h4 id="_2-2-2-应用系统的解耦"><a href="#_2-2-2-应用系统的解耦" class="header-anchor">#</a> 2.2.2 应用系统的解耦</h4> <p><strong>发送者和接收者不必了解对方，只需要确认消息</strong></p> <p><strong>发送者和接收者不必同时在线</strong></p> <h4 id="_2-2-3-现实中的业务"><a href="#_2-2-3-现实中的业务" class="header-anchor">#</a> 2.2.3 现实中的业务</h4> <p><img src="/assets/img/image6.9ca7aa4f.jpeg" alt=""></p> <h2 id="_3-各个mq产品的比较"><a href="#_3-各个mq产品的比较" class="header-anchor">#</a> 3 各个MQ产品的比较</h2> <p><img src="/assets/img/image7.fec99009.png" alt=""></p> <h2 id="_4-rocketmq重要概念【重点】"><a href="#_4-rocketmq重要概念【重点】" class="header-anchor">#</a> 4 RocketMQ重要概念【重点】</h2> <p><strong>Producer：消息的发送者，生产者；举例：发件人</strong></p> <p><strong>Consumer：消息接收者，消费者；举例：收件人</strong></p> <p><strong>Broker：暂存和传输消息的通道；举例：快递</strong></p> <p><strong>NameServer：管理Broker；举例：各个快递公司的管理机构
相当于broker的注册中心，保留了broker的信息</strong></p> <p><strong>Queue：队列，消息存放的位置，一个Broker中可以有多个队列</strong></p> <p><strong>Topic：主题，消息的分类</strong></p> <p>ProducerGroup：生产者组</p> <p>ConsumerGroup：消费者组，多个消费者组可以同时消费一个主题的消息</p> <p><strong>消息发送的流程</strong>是，Producer询问NameServer，NameServer分配一个broker
然后Consumer也要询问NameServer，得到一个具体的broker，然后消费消息</p> <p><img src="/assets/img/image8.da7f09b6.png" alt=""></p> <h2 id="_5-生产和消费理解【重点】"><a href="#_5-生产和消费理解【重点】" class="header-anchor">#</a> 5 生产和消费理解【重点】</h2> <p><img src="/assets/img/image9.e78556a3.png" alt=""></p> <h2 id="_6-rocketmq安装"><a href="#_6-rocketmq安装" class="header-anchor">#</a> 6 RocketMQ安装</h2> <p>了解了mq的基本概念和角色以后，我们开始安装rocketmq，建议在linux上</p> <h3 id="_6-1-下载rocketmq"><a href="#_6-1-下载rocketmq" class="header-anchor">#</a> 6.1 下载RocketMQ</h3> <p>下载地址：<a href="https://rocketmq.apache.org/dowloading/releases/" target="_blank" rel="noopener noreferrer">[https://rocketmq.apache.org/dowloading/releases/]{.underline}<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>注意选择版本，这里我们选择4.9.2的版本，后面使用alibaba时对应</p> <p><img src="/assets/img/image10.160333a7.png" alt=""></p> <p>下载地址：https://archive.apache.org/dist/rocketmq/4.9.2/rocketmq-all-4.9.2-bin-release.zip</p> <h3 id="_6-2-上传服务器"><a href="#_6-2-上传服务器" class="header-anchor">#</a> 6.2 上传服务器</h3> <p>在root目录下创建文件夹</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir rocketmq
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将下载后的压缩包上传到阿里云服务器或者虚拟机中去</p> <p><img src="/assets/img/image11.a0a1d1a1.png" alt=""></p> <h3 id="_6-3-解压"><a href="#_6-3-解压" class="header-anchor">#</a> 6.3 解压</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>unzip rocketmq-all-4.9.2-bin-release.zip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果你的服务器没有unzip命令，则下载安装一个</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yum install unzip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>目录分析</p> <p><img src="/assets/img/image12.da070e0d.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Benchmark：包含一些性能测试的脚本；
Bin：可执行文件目录；
Conf：配置文件目录；
Lib：第三方依赖；
LICENSE：授权信息;
NOTICE：版本公告；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_6-4-配置环境变量"><a href="#_6-4-配置环境变量" class="header-anchor">#</a> 6.4 配置环境变量</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>  vim /etc/profile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在文件末尾添加</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> export NAMESRV_ADDR=阿里云公网IP:9876
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_6-5-修改nameserver的运行脚本"><a href="#_6-5-修改nameserver的运行脚本" class="header-anchor">#</a> 6.5 修改nameServer的运行脚本</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>  进入bin目录下，修改runserver.sh文件,将71行和76行的Xms和Xmx等改小一点
  
  vim runserver.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/assets/img/image13.425ad199.png" alt=""></p> <p>保存退出</p> <h3 id="修改broker的运行脚本"><a href="#修改broker的运行脚本" class="header-anchor">#</a> 修改broker的运行脚本</h3> <p>进入bin目录下，修改runbroker.sh文件,修改67行</p> <p><img src="/assets/img/image14.a3248807.png" alt=""></p> <p>保存退出</p> <h3 id="_6-6-修改broker的配置文件"><a href="#_6-6-修改broker的配置文件" class="header-anchor">#</a> 6.6 修改broker的配置文件</h3> <p>进入conf目录下，修改broker.conf文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>brokerClusterName = DefaultCluster
brokerName = broker-a
brokerId = 0
deleteWhen = 04
fileReservedTime = 48
brokerRole = ASYNC_MASTER
flushDiskType = ASYNC_FLUSH
namesrvAddr=localhost:9876
autoCreateTopicEnable=true
brokerIP1=阿里云公网IP(写公网ip,外网可以访问到的)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>添加参数解释</p> <p>namesrvAddr：nameSrv地址，可以写localhost因为nameSrv和broker在一个服务器</p> <p>autoCreateTopicEnable：自动创建主题，不然需要手动创建出来</p> <p>brokerIP1：broker也需要一个公网ip，如果不指定，那么是阿里云的内网地址，我们在本地无法连接使用</p> <h3 id="_6-7-启动"><a href="#_6-7-启动" class="header-anchor">#</a> 6.7 启动</h3> <p>首先在安装目录下创建一个logs文件夹，用于存放日志</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir logs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image15.be0a10ce.png" alt=""></p> <p>一次运行两条命令</p> <p>启动nameSrv</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup sh bin/mqnamesrv &gt; ./logs/namesrv.log &amp;
 
nohup  ./mqnamesrv  -c  ../conf/nameserver.properties  &gt; /home/rocket_mq/nameserver_log/nohup.log 2&gt;&amp;1 &amp;

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>启动broker 这里的-c是指定使用的配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup sh bin/mqbroker -c conf/broker.conf &gt; ./logs/broker.log &amp;
 
nohup  ./mqbroker  -c  ../conf/broker.conf  &gt; /home/rocket_mq/broker_log/nohup.log 2&gt;&amp;1 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看启动结果</p> <p><img src="/assets/img/image16.29b409d8.png" alt=""></p> <h3 id="_6-8-rocketmq控制台的安装rocketmq-console"><a href="#_6-8-rocketmq控制台的安装rocketmq-console" class="header-anchor">#</a> 6.8 RocketMQ控制台的安装RocketMQ-Console</h3> <p>Rocketmq 控制台可以可视化MQ的消息发送！</p> <p>旧版本源码是在rocketmq-external里的rocketmq-console，新版本已经单独拆分成dashboard</p> <p>网址：https://github.com/apache/rocketmq-dashboard</p> <p>下载地址：https://github.com/apache/rocketmq-dashboard/archive/refs/tags/rocketmq-dashboard-1.0.0.zip</p> <p>下载后解压出来，在跟目录下执行</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mvn clean package -Dmaven.test.skip=true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image17.bcc7a77b.png" alt=""></p> <p><img src="/assets/img/image18.9ccaf05b.png" alt=""></p> <p>将jar包上传到服务器上去</p> <p><img src="/assets/img/image19.b3855310.png" alt=""></p> <p>然后运行</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup java -jar ./rocketmq-dashboard-1.0.0.jar  --rocketmq.config.namesrvAddr=127.0.0.1:9876 &gt; ./rocketmq-4.9.3/logs/dashboard.log &amp;

nohup java -jar rocketmq-console-ng-2.0.0.jar &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>命令拓展:--server.port指定运行的端口
--rocketmq.config.namesrvAddr=127.0.0.1:9876 指定namesrv地址
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>访问： <a href="http://localhost:8081" target="_blank" rel="noopener noreferrer">http://localhost:8001<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>运行访问端口是8001，如果从官网拉下来打包的话，默认端口是8080</p> <p><img src="/assets/img/image20.4f62e820.png" alt=""></p> <h3 id="_6-9-阿里云放行-nameserver-9876-broker-10100-11000"><a href="#_6-9-阿里云放行-nameserver-9876-broker-10100-11000" class="header-anchor">#</a> 6.9  阿里云放行  nameServer 9876    broker 10100 - 11000</h3> <h2 id="_7-rocketmq安装之docker"><a href="#_7-rocketmq安装之docker" class="header-anchor">#</a> 7 RocketMQ安装之docker</h2> <h3 id="_7-1-下载rockermq需要的镜像"><a href="#_7-1-下载rockermq需要的镜像" class="header-anchor">#</a> 7.1 下载RockerMQ需要的镜像</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker pull rocketmqinc/rocketmq

docker pull styletang/rocketmq-console-ng
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_7-2-启动nameserver服务"><a href="#_7-2-启动nameserver服务" class="header-anchor">#</a> 7.2 启动NameServer服务</h3> <h4 id="_7-2-1-创建nameserver数据存储路径"><a href="#_7-2-1-创建nameserver数据存储路径" class="header-anchor">#</a> 7.2.1 创建NameServer数据存储路径</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /home/rocketmq/data/namesrv/logs /home/rocketmq/data/namesrv/store
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_7-2-2-启动nameserver容器"><a href="#_7-2-2-启动nameserver容器" class="header-anchor">#</a> 7.2.2 启动NameServer容器</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run -d --name rmqnamesrv -p 9876:9876 -v /home/rocketmq/data/namesrv/logs:/root/logs -v /home/rocketmq/data/namesrv/store:/root/store -e &quot;MAX_POSSIBLE_HEAP=100000000&quot; rocketmqinc/rocketmq sh mqnamesrv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_7-3-启动broker服务"><a href="#_7-3-启动broker服务" class="header-anchor">#</a> 7.3 启动Broker服务</h3> <h4 id="_7-3-1-创建broker数据存储路径"><a href="#_7-3-1-创建broker数据存储路径" class="header-anchor">#</a> 7.3.1 创建Broker数据存储路径</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /home/rocketmq/data/broker/logs /home/rocketmq/data/broker/store
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_7-3-2-创建conf配置文件目录"><a href="#_7-3-2-创建conf配置文件目录" class="header-anchor">#</a> 7.3.2 创建conf配置文件目录</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir /home/rocketmq/conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_7-3-3-在配置文件目录下创建broker-conf配置文件"><a href="#_7-3-3-在配置文件目录下创建broker-conf配置文件" class="header-anchor">#</a> 7.3.3 在配置文件目录下创建broker.conf配置文件</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code># 所属集群名称，如果节点较多可以配置多个
brokerClusterName = DefaultCluster
#broker名称，master和slave使用相同的名称，表明他们的主从关系
brokerName = broker-a
#0表示Master，大于0表示不同的slave
brokerId = 0
#表示几点做消息删除动作，默认是凌晨4点
deleteWhen = 04
#在磁盘上保留消息的时长，单位是小时
fileReservedTime = 48
#有三个值：SYNC_MASTER，ASYNC_MASTER，SLAVE；同步和异步表示Master和Slave之间同步数据的机制；
brokerRole = ASYNC_MASTER
#刷盘策略，取值为：ASYNC_FLUSH，SYNC_FLUSH表示同步刷盘和异步刷盘；SYNC_FLUSH消息写入磁盘后才返回成功状态，ASYNC_FLUSH不需要；
flushDiskType = ASYNC_FLUSH
# 设置broker节点所在服务器的ip地址
brokerIP1 = 你服务器外网ip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_7-3-4-启动broker容器"><a href="#_7-3-4-启动broker容器" class="header-anchor">#</a> 7.3.4 启动Broker容器</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run -d  --name rmqbroker --link rmqnamesrv:namesrv -p 10911:10911 -p 10909:10909 -v  /home/rocketmq/data/broker/logs:/root/logs -v /home/rocketmq/data/broker/store:/root/store -v /home/rocketmq/conf/broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf --privileged=true -e &quot;NAMESRV_ADDR=namesrv:9876&quot; -e &quot;MAX_POSSIBLE_HEAP=200000000&quot; rocketmqinc/rocketmq sh mqbroker -c /opt/rocketmq-4.4.0/conf/broker.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_7-4-启动控制台"><a href="#_7-4-启动控制台" class="header-anchor">#</a> 7.4 启动控制台</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run -d --name rmqadmin -e &quot;JAVA_OPTS=-Drocketmq.namesrv.addr=你的外网地址:9876 \
-Dcom.rocketmq.sendMessageWithVIPChannel=false \
-Duser.timezone='Asia/Shanghai'&quot; -v /etc/localtime:/etc/localtime -p 9999:8080 styletang/rocketmq-console-ng
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_7-5-正常启动后的docker-ps"><a href="#_7-5-正常启动后的docker-ps" class="header-anchor">#</a> 7.5 正常启动后的docker ps</h3> <p><img src="/assets/img/image21.f888d660.png" alt=""></p> <h3 id="_7-6-访问控制台"><a href="#_7-6-访问控制台" class="header-anchor">#</a> 7.6 访问控制台</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://你的服务器外网ip:9999/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image22.19f74ecc.png" alt=""></p> <h2 id="_8-rocketmq快速入门"><a href="#_8-rocketmq快速入门" class="header-anchor">#</a> 8 RocketMQ快速入门</h2> <p>RocketMQ提供了发送多种发送消息的模式，例如同步消息，异步消息，顺序消息，延迟消息，事务消息等，我们一一学习</p> <h3 id="_8-1-消息发送和监听的流程"><a href="#_8-1-消息发送和监听的流程" class="header-anchor">#</a> 8.1 消息发送和监听的流程</h3> <p>我们先搞清楚消息发送和监听的流程，然后我们在开始敲代码</p> <h4 id="_8-1-1-消息生产者"><a href="#_8-1-1-消息生产者" class="header-anchor">#</a> 8.1.1 消息生产者</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>1.创建消息生产者producer，并制定生产者组名
2.指定Nameserver地址
3.启动producer
4.创建消息对象，指定主题Topic、Tag和消息体等
5.发送消息
6.关闭生产者producer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_8-1-2-消息消费者"><a href="#_8-1-2-消息消费者" class="header-anchor">#</a> 8.1.2 消息消费者</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>1.创建消费者consumer，制定消费者组名
2.指定Nameserver地址
3.创建监听订阅主题Topic和Tag等
4.处理消息
5.启动消费者consumer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_8-2-搭建rocketmq-demo"><a href="#_8-2-搭建rocketmq-demo" class="header-anchor">#</a> 8.2 搭建Rocketmq-demo</h3> <h4 id="_8-2-1-加入依赖"><a href="#_8-2-1-加入依赖" class="header-anchor">#</a> 8.2.1 加入依赖</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;
        &lt;artifactId&gt;rocketmq-client&lt;/artifactId&gt;
        &lt;version&gt;4.9.2&lt;/version&gt;
        &lt;!--docker的用下面这个版本--&gt;
&lt;version&gt;4.4.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;4.12&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;version&gt;1.18.22&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_8-2-2-编写生产者"><a href="#_8-2-2-编写生产者" class="header-anchor">#</a> 8.2.2 编写生产者</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>/**
 * 测试生产者
 *
 * @throws Exception
 */
@Test
public void testProducer() throws Exception {
    // 创建默认的生产者
    DefaultMQProducer producer = new DefaultMQProducer(&quot;test-group&quot;);
    // 设置nameServer地址
    producer.setNamesrvAddr(&quot;localhost:9876&quot;);
    // 启动实例
    producer.start();
    for (int i = 0; i &lt; 10; i++) {
        // 创建消息
        // 第一个参数：主题的名字
        // 第二个参数：消息内容
        Message msg = new Message(&quot;TopicTest&quot;, (&quot;Hello RocketMQ &quot; + i).getBytes());
        SendResult send = producer.send(msg);
        System.out.println(send);
    }
    // 关闭实例
    producer.shutdown();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="_8-2-3-编写消费者"><a href="#_8-2-3-编写消费者" class="header-anchor">#</a> 8.2.3 编写消费者</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>   /**
     * 测试消费者
     *
     * @throws Exception
     */
    @Test
    public void testConsumer() throws Exception {
        // 创建默认消费者组
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;consumer-group&quot;);
        // 设置nameServer地址
        consumer.setNamesrvAddr(&quot;localhost:9876&quot;);
        // 订阅一个主题来消费   *表示没有过滤参数 表示这个主题的任何消息
        consumer.subscribe(&quot;TopicTest&quot;, &quot;*&quot;);
        // 注册一个消费监听 MessageListenerConcurrently 是多线程消费，默认20个线程，可以参看consumer.setConsumeThreadMax()
        consumer.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs,
                                                            ConsumeConcurrentlyContext context) {
                System.out.println(Thread.currentThread().getName() + &quot;----&quot; + msgs);
                // 返回消费的状态 如果是CONSUME_SUCCESS 则成功，若为RECONSUME_LATER则该条消息会被重回队列，重新被投递
                // 重试的时间为messageDelayLevel = &quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h
                // 也就是第一次1s 第二次5s 第三次10s  ....  如果重试了18次 那么这个消息就会被终止发送给消费者
//                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
                return ConsumeConcurrentlyStatus.RECONSUME_LATER;
            }
        });
        // 这个start一定要写在registerMessageListener下面
        consumer.start();
        System.in.read();
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="_8-2-4-测试"><a href="#_8-2-4-测试" class="header-anchor">#</a> 8.2.4 测试</h4> <p>启动生产者和消费者进行测试</p> <h2 id="_9-消费模式"><a href="#_9-消费模式" class="header-anchor">#</a> 9 消费模式</h2> <p>MQ的消费模式可以大致分为两种，一种是推Push，一种是拉Pull。</p> <p>Push是服务端【MQ】主动推送消息给客户端，优点是及时性较好，但如果客户端没有做好流控，一旦服务端推送大量消息到客户端时，就会导致客户端消息堆积甚至崩溃。</p> <p>Pull是客户端需要主动到服务端取数据，优点是客户端可以依据自己的消费能力进行消费，但拉取的频率也需要用户自己控制，拉取频繁容易造成服务端和客户端的压力，拉取间隔长又容易造成消费不及时。</p> <p>Push模式也是基于pull模式的，只能客户端内部封装了api，一般场景下，上游消息生产量小或者均速的时候，选择push模式。在特殊场景下，例如电商大促，抢优惠券等场景可以选择pull模式</p> <h2 id="_10-rocketmq发送同步消息"><a href="#_10-rocketmq发送同步消息" class="header-anchor">#</a> 10 RocketMQ发送同步消息</h2> <p>上面的快速入门就是发送同步消息，发送过后会有一个返回值，也就是mq服务器接收到消息后返回的一个确认，这种方式非常安全，但是性能上并没有这么高，而且在mq集群中，也是要等到所有的从机都复制了消息以后才会返回，所以针对重要的消息可以选择这种方式</p> <p><img src="/assets/img/image23.e9daf125.png" alt=""></p> <h2 id="_11-rocketmq发送异步消息"><a href="#_11-rocketmq发送异步消息" class="header-anchor">#</a> 11 RocketMQ发送异步消息</h2> <p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待Broker的响应。发送完以后会有一个异步消息通知</p> <h3 id="_11-1-异步消息生产者"><a href="#_11-1-异步消息生产者" class="header-anchor">#</a> 11.1 异步消息生产者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAsyncProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认的生产者</span>
    <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;test-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动实例</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;异步消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;看看谁先执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 挂起jvm 因为回调是异步的不然测试不出来</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭实例</span>
    producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_11-2-异步消息消费者"><a href="#_11-2-异步消息消费者" class="header-anchor">#</a> 11.2 异步消息消费者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAsyncConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认消费者组</span>
    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅一个主题来消费   *表示没有过滤参数 表示这个主题的任何消息</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册一个消费监听 MessageListenerConcurrently是并发消费</span>
    <span class="token comment">// 默认是20个线程一起消费，可以参看 consumer.setConsumeThreadMax()</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                        <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里执行消费的代码 默认是多线程消费</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;----&quot;</span> <span class="token operator">+</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="_12-rocketmq发送单向消息"><a href="#_12-rocketmq发送单向消息" class="header-anchor">#</a> 12 RocketMQ发送单向消息</h2> <p>这种方式主要用在不关心发送结果的场景，这种方式吞吐量很大，但是存在消息丢失的风险，例如日志信息的发送</p> <h3 id="_12-1-单向消息生产者"><a href="#_12-1-单向消息生产者" class="header-anchor">#</a> 12.1 单向消息生产者</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Test
public void testOnewayProducer() throws Exception {
    // 创建默认的生产者
    DefaultMQProducer producer = new DefaultMQProducer(&quot;test-group&quot;);
    // 设置nameServer地址
    producer.setNamesrvAddr(&quot;localhost:9876&quot;);
    // 启动实例
    producer.start();
    Message msg = new Message(&quot;TopicTest&quot;, (&quot;单向消息&quot;).getBytes());
    // 发送单向消息
    producer.sendOneway(msg);
    // 关闭实例
    producer.shutdown();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_12-2-单向消息消费者"><a href="#_12-2-单向消息消费者" class="header-anchor">#</a> 12.2 单向消息消费者</h3> <p>消费者和上面一样</p> <h2 id="_13-rocketmq发送延迟消息"><a href="#_13-rocketmq发送延迟消息" class="header-anchor">#</a> 13 RocketMQ发送延迟消息</h2> <p>消息放入mq后，过一段时间，才会被监听到，然后消费</p> <p>比如下订单业务，提交了一个订单就可以发送一个延时消息，30min后去检查这个订单的状态，如果还是未付款就取消订单释放库存。</p> <h3 id="_13-1-延迟消息生产者"><a href="#_13-1-延迟消息生产者" class="header-anchor">#</a> 13.1 延迟消息生产者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDelayProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认的生产者</span>
    <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;test-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动实例</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;延迟消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 给这个消息设定一个延迟等级</span>
    <span class="token comment">// messageDelayLevel = &quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</span>
    msg<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送单向消息</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印时间</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭实例</span>
    producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_13-2-延迟消息消费者"><a href="#_13-2-延迟消息消费者" class="header-anchor">#</a> 13.2 延迟消息消费者</h3> <p>消费者和上面一样</p> <p>这里注意的是RocketMQ不支持任意时间的延时</p> <p>只支持以下几个固定的延时等级，等级1就对应1s，以此类推，最高支持2h延迟</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private String messageDelayLevel = &quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_14-rocketmq发送顺序消息"><a href="#_14-rocketmq发送顺序消息" class="header-anchor">#</a> 14 RocketMQ发送顺序消息</h2> <p>消息有序指的是可以<strong>按照消息的发送顺序来消费</strong>(FIFO)。RocketMQ可以严格的保证消息有序，可以分为：分区有序或者全局有序。</p> <p>可能大家会有疑问，mq不就是FIFO吗？</p> <p>rocketMq的broker的机制，导致了rocketMq会有这个问题</p> <p>因为一个broker中对应了四个queue</p> <p><img src="/assets/img/image24.850103ca.png" alt=""></p> <p>顺序消费的原理解析，在默认的情况下消息发送会采取Round
Robin轮询方式把消息发送到不同的queue(分区队列)；而消费消息的时候从多个queue上拉取消息，这种情况发送和消费是不能保证顺序。但是如果控制发送的顺序消息只依次发送到同一个queue中，消费的时候只从这个queue上依次拉取，则就保证了顺序。当发送和消费参与的queue只有一个，则是全局有序；如果多个queue参与，则为分区有序，即相对每个queue，消息都是有序的。</p> <p>下面用订单进行分区有序的示例。一个订单的顺序流程是：下订单、发短信通知、物流、签收。订单顺序号相同的消息会被先后发送到同一个队列中，消费时，同一个顺序获取到的肯定是同一个队列。</p> <h3 id="_14-1-场景分析"><a href="#_14-1-场景分析" class="header-anchor">#</a> 14.1 场景分析</h3> <p>模拟一个订单的发送流程，创建两个订单，发送的消息分别是</p> <p>订单号111 消息流程 下订单-&gt;物流-&gt;签收</p> <p>订单号112 消息流程 下订单-&gt;物流-&gt;拒收</p> <h3 id="_14-2-创建一个订单对象"><a href="#_14-2-创建一个订单对象" class="header-anchor">#</a> 14.2 创建一个订单对象</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Data
@AllArgsConstructor
@NoArgsConstructor
public class Order {
    /**
     * 订单id
     */
    private Integer orderId;

    /**
     * 订单编号
     */
    private Integer orderNumber;
    
    /**
     * 订单价格
     */
    private Double price;

    /**
     * 订单号创建时间
     */
    private Date createTime;

    /**
     * 订单描述
     */
    private String desc;

}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="_14-3-顺序消息生产者"><a href="#_14-3-顺序消息生产者" class="header-anchor">#</a> 14.3 顺序消息生产者</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Test
public void testOrderlyProducer() throws Exception {
    // 创建默认的生产者
    DefaultMQProducer producer = new DefaultMQProducer(&quot;test-group&quot;);
    // 设置nameServer地址
    producer.setNamesrvAddr(&quot;localhost:9876&quot;);
    // 启动实例
    producer.start();
    List&lt;Order&gt; orderList = Arrays.asList(
            new Order(1, 111, 59D, new Date(), &quot;下订单&quot;),
            new Order(2, 111, 59D, new Date(), &quot;物流&quot;),
            new Order(3, 111, 59D, new Date(), &quot;签收&quot;),
            new Order(4, 112, 89D, new Date(), &quot;下订单&quot;),
            new Order(5, 112, 89D, new Date(), &quot;物流&quot;),
            new Order(6, 112, 89D, new Date(), &quot;拒收&quot;)
    );
    // 循环集合开始发送
    orderList.forEach(order -&gt; {
        Message message = new Message(&quot;TopicTest&quot;, order.toString().getBytes());
        try {
            // 发送的时候 相同的订单号选择同一个队列
            producer.send(message, new MessageQueueSelector() {
                @Override
                public MessageQueue select(List&lt;MessageQueue&gt; mqs, Message msg, Object arg) {
                    // 当前主题有多少个队列
                    int queueNumber = mqs.size();
                    // 这个arg就是后面传入的 order.getOrderNumber()
                    Integer i = (Integer) arg;
                    // 用这个值去%队列的个数得到一个队列
                    int index = i % queueNumber;
                    // 返回选择的这个队列即可 ，那么相同的订单号 就会被放在相同的队列里 实现FIFO了
                    return mqs.get(index);
                }
            }, order.getOrderNumber());
        } catch (Exception e) {
            System.out.println(&quot;发送异常&quot;);
        }
    });
    // 关闭实例
    producer.shutdown();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="_14-4-顺序消息消费者-测试时等一会即可有延迟"><a href="#_14-4-顺序消息消费者-测试时等一会即可有延迟" class="header-anchor">#</a> 14.4 顺序消息消费者，测试时等一会即可有延迟</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Test
public void testOrderlyConsumer() throws Exception {
    // 创建默认消费者组
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;consumer-group&quot;);
    // 设置nameServer地址
    consumer.setNamesrvAddr(&quot;localhost:9876&quot;);
    // 订阅一个主题来消费   *表示没有过滤参数 表示这个主题的任何消息
    consumer.subscribe(&quot;TopicTest&quot;, &quot;*&quot;);
    // 注册一个消费监听 MessageListenerOrderly 是顺序消费 单线程消费
    consumer.registerMessageListener(new MessageListenerOrderly() {
        @Override
        public ConsumeOrderlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context) {
            MessageExt messageExt = msgs.get(0);
            System.out.println(new String(messageExt.getBody()));
            return ConsumeOrderlyStatus.SUCCESS;
        }
    });
    consumer.start();
    System.in.read();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="_15-rocketmq发送批量消息"><a href="#_15-rocketmq发送批量消息" class="header-anchor">#</a> 15 RocketMQ发送批量消息</h2> <p>Rocketmq可以一次性发送一组消息，那么这一组消息会被当做一个消息消费</p> <h3 id="_15-1-批量消息生产者"><a href="#_15-1-批量消息生产者" class="header-anchor">#</a> 15.1 批量消息生产者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBatchProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认的生产者</span>
    <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;test-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动实例</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> msgs <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是一组消息的A消息&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是一组消息的B消息&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是一组消息的C消息&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SendResult</span> send <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭实例</span>
    producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_15-2-批量消息消费者"><a href="#_15-2-批量消息消费者" class="header-anchor">#</a> 15.2 批量消息消费者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBatchConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认消费者组</span>
    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅一个主题来消费   表达式，默认是*</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册一个消费监听 MessageListenerConcurrently是并发消费</span>
    <span class="token comment">// 默认是20个线程一起消费，可以参看 consumer.setConsumeThreadMax()</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                        <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里执行消费的代码 默认是多线程消费</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;----&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="_16-rocketmq发送事务消息"><a href="#_16-rocketmq发送事务消息" class="header-anchor">#</a> 16 RocketMQ发送事务消息</h2> <h3 id="_16-1-事务消息的发送流程"><a href="#_16-1-事务消息的发送流程" class="header-anchor">#</a> 16.1 事务消息的发送流程</h3> <p>它可以被认为是一个两阶段的提交消息实现，以确保分布式系统的最终一致性。事务性消息确保本地事务的执行和消息的发送可以原子地执行。</p> <p><img src="/assets/img/image25.f9300f5f.png" alt=""></p> <p><img src="/assets/img/image26.556985b1.png" alt=""></p> <p>上图说明了事务消息的大致方案，其中分为两个流程：正常事务消息的发送及提交、事务消息的补偿流程。</p> <p><strong>事务消息发送及提交</strong></p> <ol><li><p>发送消息（half消息）。</p></li> <li><p>服务端响应消息写入结果。</p></li> <li><p>根据发送结果执行本地事务（如果写入失败，此时half消息对业务不可见，本地逻辑不执行）。</p></li> <li><p>根据本地事务状态执行Commit或Rollback（Commit操作生成消息索引，消息对消费者可见）</p></li></ol> <p><strong>事务补偿</strong></p> <ol><li><p>对没有Commit/Rollback的事务消息（pending状态的消息），从服务端发起一次&quot;回查&quot;</p></li> <li><p>Producer收到回查消息，检查回查消息对应的本地事务的状态</p></li> <li><p>根据本地事务状态，重新Commit或者Rollback</p></li></ol> <p>其中，补偿阶段用于解决消息UNKNOW或者Rollback发生超时或者失败的情况。</p> <p><strong>事务消息状态</strong></p> <p>事务消息共有三种状态，提交状态、回滚状态、中间状态：</p> <ul><li><p>TransactionStatus.CommitTransaction:
提交事务，它允许消费者消费此消息。</p></li> <li><p>TransactionStatus.RollbackTransaction:
回滚事务，它代表该消息将被删除，不允许被消费。</p></li> <li><p>TransactionStatus.Unknown:
中间状态，它代表需要检查消息队列来确定状态。</p></li></ul> <h3 id="_16-2-事务消息生产者"><a href="#_16-2-事务消息生产者" class="header-anchor">#</a> 16.2 事务消息生产者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * TransactionalMessageCheckService的检测频率默认1分钟，可通过在broker.conf文件中设置transactionCheckInterval的值来改变默认值，单位为毫秒。
 * 从broker配置文件中获取transactionTimeOut参数值。
 * 从broker配置文件中获取transactionCheckMax参数值，表示事务的最大检测次数，如果超过检测次数，消息会默认为丢弃，即回滚消息。
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTransactionProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个事务消息生产者</span>
    <span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;test-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置事务消息监听器</span>
    producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这个是执行本地业务方法</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 这个可以使用try catch对业务代码进行性包裹</span>
            <span class="token comment">// COMMIT_MESSAGE 表示允许消费者消费该消息</span>
            <span class="token comment">// ROLLBACK_MESSAGE 表示该消息将被删除，不允许消费</span>
            <span class="token comment">// UNKNOW表示需要MQ回查才能确定状态 那么过一会 代码会走下面的checkLocalTransaction(msg)方法</span>
            <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 这里是回查方法 回查不是再次执行业务操作，而是确认上面的操作是否有结果</span>
        <span class="token comment">// 默认是1min回查 默认回查15次 超过次数则丢弃打印日志 可以通过参数设置</span>
        <span class="token comment">// transactionTimeOut 超时时间</span>
        <span class="token comment">// transactionCheckMax 最大回查次数</span>
        <span class="token comment">// transactionCheckInterval 回查间隔时间单位毫秒</span>
        <span class="token comment">// 触发条件</span>
        <span class="token comment">// 1.当上面执行本地事务返回结果UNKNOW时,或者下面的回查方法也返回UNKNOW时 会触发回查</span>
        <span class="token comment">// 2.当上面操作超过20s没有做出一个结果，也就是超时或者卡主了，也会进行回查</span>
                <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 这里</span>
            <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是一个事务消息&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送消息</span>
    producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="_16-3-事务消息消费者"><a href="#_16-3-事务消息消费者" class="header-anchor">#</a> 16.3 事务消息消费者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTransactionConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认消费者组</span>
    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅一个主题来消费   *表示没有过滤参数 表示这个主题的任何消息</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册一个消费监听 MessageListenerConcurrently是并发消费</span>
    <span class="token comment">// 默认是20个线程一起消费，可以参看 consumer.setConsumeThreadMax()</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                        <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里执行消费的代码 默认是多线程消费</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;----&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_16-4-测试结果"><a href="#_16-4-测试结果" class="header-anchor">#</a> 16.4 测试结果</h3> <p><img src="/assets/img/image27.6fddc9d2.png" alt=""></p> <h2 id="_17-rocketmq发送带标签的消息-消息过滤"><a href="#_17-rocketmq发送带标签的消息-消息过滤" class="header-anchor">#</a> 17 RocketMQ发送带标签的消息，消息过滤</h2> <p>Rocketmq提供消息过滤功能，通过tag或者key进行区分</p> <p>我们往一个主题里面发送消息的时候，根据业务逻辑，可能需要区分，比如带有tagA标签的被A消费，带有tagB标签的被B消费，还有在事务监听的类里面，只要是事务消息都要走同一个监听，我们也需要通过过滤才区别对待</p> <h3 id="_17-1-标签消息生产者"><a href="#_17-1-标签消息生产者" class="header-anchor">#</a> 17.1 标签消息生产者</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Test
public void testTagProducer() throws Exception {
    // 创建默认的生产者
    DefaultMQProducer producer = new DefaultMQProducer(&quot;test-group&quot;);
    // 设置nameServer地址
    producer.setNamesrvAddr(&quot;localhost:9876&quot;);
    // 启动实例
    producer.start();
    Message msg = new Message(&quot;TopicTest&quot;,&quot;tagA&quot;, &quot;我是一个带标记的消息&quot;.getBytes());
    SendResult send = producer.send(msg);
    System.out.println(send);
    // 关闭实例
    producer.shutdown();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_17-2-标签消息消费者"><a href="#_17-2-标签消息消费者" class="header-anchor">#</a> 17.2 标签消息消费者</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Test
public void testTagConsumer() throws Exception {
    // 创建默认消费者组
    DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;consumer-group&quot;);
    // 设置nameServer地址
    consumer.setNamesrvAddr(&quot;localhost:9876&quot;);
    // 订阅一个主题来消费   表达式，默认是*,支持&quot;tagA || tagB || tagC&quot; 这样或者的写法 只要是符合任何一个标签都可以消费
    consumer.subscribe(&quot;TopicTest&quot;, &quot;tagA || tagB || tagC&quot;);
    // 注册一个消费监听 MessageListenerConcurrently是并发消费
    // 默认是20个线程一起消费，可以参看 consumer.setConsumeThreadMax()
    consumer.registerMessageListener(new MessageListenerConcurrently() {
        @Override
        public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs,
                                                        ConsumeConcurrentlyContext context) {
            // 这里执行消费的代码 默认是多线程消费
            System.out.println(Thread.currentThread().getName() + &quot;----&quot; + new String(msgs.get(0).getBody()));
            System.out.println(msgs.get(0).getTags());
            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        }
    });
    consumer.start();
    System.in.read();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_17-3-什么时候该用-topic-什么时候该用-tag"><a href="#_17-3-什么时候该用-topic-什么时候该用-tag" class="header-anchor">#</a> 17.3 什么时候该用 Topic，什么时候该用 Tag？</h3> <p>总结：不同的业务应该使用不同的Topic如果是相同的业务里面有不同表的表现形式，那么我们要使用tag进行区分</p> <p>可以从以下几个方面进行判断：</p> <p>1.消息类型是否一致：如普通消息、事务消息、定时（延时）消息、顺序消息，不同的消息类型使用不同的
Topic，无法通过 Tag 进行区分。</p> <p>2.业务是否相关联：没有直接关联的消息，如淘宝交易消息，京东物流消息使用不同的
Topic
进行区分；而同样是天猫交易消息，电器类订单、女装类订单、化妆品类订单的消息可以用
Tag 进行区分。</p> <p>3.消息优先级是否一致：如同样是物流消息，盒马必须小时内送达，天猫超市 24
小时内送达，淘宝物流则相对会慢一些，不同优先级的消息用不同的 Topic
进行区分。</p> <p>4.消息量级是否相当：有些业务消息虽然量小但是实时性要求高，如果跟某些万亿量级的消息使用同一个
Topic，则有可能会因为过长的等待时间而&quot;饿死&quot;，此时需要将不同量级的消息进行拆分，使用不同的
Topic。</p> <p><strong>总的来说，针对消息分类，您可以选择创建多个 Topic，或者在同一个 Topic
下创建多个 Tag。但通常情况下，不同的 Topic 之间的消息没有必然的联系，而
Tag 则用来区分同一个 Topic
下相互关联的消息，例如全集和子集的关系、流程先后的关系。</strong></p> <h2 id="_18-rocketmq中消息的key"><a href="#_18-rocketmq中消息的key" class="header-anchor">#</a> 18 RocketMQ中消息的Key</h2> <p>在rocketmq中的消息，默认会有一个messageId当做消息的唯一标识，我们也可以给消息携带一个key，用作唯一标识或者业务标识，包括在控制面板查询的时候也可以使用messageId或者key来进行查询</p> <p><img src="/assets/img/image28.f717a43c.png" alt=""></p> <h3 id="_18-1-带key消息生产者"><a href="#_18-1-带key消息生产者" class="header-anchor">#</a> 18.1 带key消息生产者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testKeyProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认的生产者</span>
    <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;test-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动实例</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tagA&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是一个带标记和key的消息&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SendResult</span> send <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭实例</span>
    producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_18-2-带key消息消费者"><a href="#_18-2-带key消息消费者" class="header-anchor">#</a> 18.2 带key消息消费者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testKeyConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认消费者组</span>
    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅一个主题来消费   表达式，默认是*,支持&quot;tagA || tagB || tagC&quot; 这样或者的写法 只要是符合任何一个标签都可以消费</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tagA || tagB || tagC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册一个消费监听 MessageListenerConcurrently是并发消费</span>
    <span class="token comment">// 默认是20个线程一起消费，可以参看 consumer.setConsumeThreadMax()</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                        <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里执行消费的代码 默认是多线程消费</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;----&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><img src="/assets/img/image29.e1e90a55.png" alt=""></p> <h2 id="_19-rocketmq重试机制"><a href="#_19-rocketmq重试机制" class="header-anchor">#</a> 19 RocketMQ重试机制</h2> <h3 id="_19-1-生产者重试"><a href="#_19-1-生产者重试" class="header-anchor">#</a> 19.1 生产者重试</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 失败的情况重发3次</span>
producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendFailed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 消息在1S内没有发送成功，就会重试</span>
producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_19-2-消费者重试"><a href="#_19-2-消费者重试" class="header-anchor">#</a> 19.2 消费者重试</h3> <p>在消费者放return
ConsumeConcurrentlyStatus.RECONSUME_LATER;后就会执行重试</p> <p>上图代码中说明了，我们再实际生产过程中，一般重试3-5次，如果还没有消费成功，则可以把消息签收了，通知人工等处理</p> <p><strong>自定义重试次数</strong> <strong>消费者默认重试16次,重试时间与延时队列时间相同,不过是第一次重试是从10s开始的 ,10s 30s 1m ..., 可以自定义重试次数</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//设置重试次数一般为5 次</span>
consumer<span class="token punctuation">.</span><span class="token function">setMaxReconsumeTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>重试16次之后，消息会放在死信消息队列中,消费者并发模式下会重试16次,顺序模式下重试int最大值次</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试消费者
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认消费者组</span>
    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅一个主题来消费   *表示没有过滤参数 表示这个主题的任何消息</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册一个消费监听</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                        <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 这里执行消费的代码</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;----&quot;</span> <span class="token operator">+</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 这里制造一个错误</span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 出现问题 判断重试的次数</span>
                <span class="token class-name">MessageExt</span> messageExt <span class="token operator">=</span> msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 获取重试的次数 失败一次消息中的失败次数会累加一次</span>
                <span class="token keyword">int</span> reconsumeTimes <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>reconsumeTimes <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 则把消息确认了，可以将这条消息记录到日志或者数据库 通知人工处理</span>
                    <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">RECONSUME_LATER</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="_20-rocketmq死信消息"><a href="#_20-rocketmq死信消息" class="header-anchor">#</a> 20 RocketMQ死信消息</h2> <p>当消费重试到达阈值以后，消息不会被投递给消费者了，而是进入了死信队列</p> <p>当一条消息初次消费失败，RocketMQ会自动进行消息重试，达到最大重试次数后，若消费依然失败，则表明消费者在正常情况下无法正确地消费该消息。此时，该消息不会立刻被丢弃，而是将其发送到该消费者对应的特殊队列中，这类消息称为死信消息（Dead-Letter
Message），存储死信消息的特殊队列称为死信队列（Dead-Letter
Queue），死信队列是死信Topic下分区数唯一的单独队列。如果产生了死信消息，那对应的ConsumerGroup的死信Topic名称为%DLQ%ConsumerGroupName，死信队列的消息将不会再被消费。可以利用RocketMQ
Admin工具或者RocketMQ
Dashboard上查询到对应死信消息的信息。我们也可以去监听死信队列，然后进行自己的业务上的逻辑</p> <p><strong>处理方式</strong></p> <p><strong>一种是监听死信队列,在死信队列中定义逻辑</strong></p> <p><strong>另一种是在消费者中try..catch 业务逻辑,try中执行正常逻辑，返回broker成功 , 在catch中 获取重试次数, 然后定义重试次数大于多少次之后执行死信逻辑,签收，返回broker成功,否则在继续返回broker重试</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>message<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_20-1-消息生产者"><a href="#_20-1-消息生产者" class="header-anchor">#</a> 20.1 消息生产者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDeadMsgProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;dead-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;dead-topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是一个死信消息&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_20-2-消息消费者"><a href="#_20-2-消息消费者" class="header-anchor">#</a> 20.2 消息消费者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDeadMsgConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;dead-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;dead-topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置最大消费重试次数 2 次</span>
    consumer<span class="token punctuation">.</span><span class="token function">setMaxReconsumeTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 测试消费失败</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">RECONSUME_LATER</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_20-3-死信消费者"><a href="#_20-3-死信消费者" class="header-anchor">#</a> 20.3 死信消费者</h3> <p>注意权限问题 2 只能读不能写  4 只能写不能读 6 可写可读</p> <p><img src="/assets/img/image30.9f5e2eb8.png" alt=""></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDeadMq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;dead-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 消费重试到达阈值以后，消息不会被投递给消费者了，而是进入了死信队列</span>
    <span class="token comment">// 队列名称 默认是 %DLQ% + 消费者组名</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;%DLQ%dead-group&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理消息 签收了</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_20-4-控制台显示"><a href="#_20-4-控制台显示" class="header-anchor">#</a> 20.4 控制台显示</h3> <p><img src="/assets/img/image31.ad5469d9.png" alt=""></p> <p><img src="/assets/img/image32.e1a7a068.png" alt=""></p> <h2 id="_21-rocketmq消息重复消费问题"><a href="#_21-rocketmq消息重复消费问题" class="header-anchor">#</a> 21 RocketMQ消息重复消费问题</h2> <h3 id="_21-1-为什么会出现重复消费问题呢"><a href="#_21-1-为什么会出现重复消费问题呢" class="header-anchor">#</a> 21.1 为什么会出现重复消费问题呢？</h3> <p>BROADCASTING(广播)模式下，所有注册的消费者都会消费，而这些消费者通常是集群部署的一个个微服务，这样就会多台机器重复消费，当然这个是根据需要来选择。</p> <p>CLUSTERING（负载均衡）模式下，如果一个topic被多个consumerGroup消费，也会重复消费。</p> <p>即使是在CLUSTERING模式下，同一个consumerGroup下，一个队列只会分配给一个消费者，看起来好像是不会重复消费。但是，有个特殊情况：一个消费者新上线后，同组的所有消费者要重新负载均衡（反之一个消费者掉线后，也一样）。一个队列所对应的新的消费者要获取之前消费的offset（偏移量，也就是消息消费的点位），此时之前的消费者可能已经消费了一条消息，但是并没有把offset提交给broker，那么新的消费者可能会重新消费一次。虽然orderly模式是前一个消费者先解锁，后一个消费者加锁再消费的模式，比起concurrently要严格了，但是加锁的线程和提交offset的线程不是同一个，所以还是会出现极端情况下的重复消费。</p> <p>还有在发送批量消息的时候，会被当做一条消息进行处理，那么如果批量消息中有一条业务处理成功，其他失败了，还是会被重新消费一次。</p> <p><strong>那么如果在CLUSTERING（负载均衡）模式下，并且在同一个消费者组中，不希望一条消息被重复消费，改怎么办呢？我们可以想到去重操作，找到消息唯一的标识，可以是msgId也可以是你自定义的唯一的key，这样就可以去重了</strong></p> <p><strong>如果同一条消息，发送者主动发送两次会产生重复消费问题或者发送者发送第一次，消费者消费但是没返回成功，发送者会重试重新发送，产生重复消费问题，或者消费者的重新负载均衡ReBalance也会造成重复消费的问题，假如一开始在同组下只有一个消费者，第一个消费者消费开始消费，此时broker中的点位未移动，表示还没有消费完成，第二个同组消费者进来，进行重排序，假如第二个消费者会消费对应的队列上的消息，正好此时第一个消费者尚未消费完成，第二个消费者则会收到消息的推送，从而继续消费，造成重复消费</strong></p> <p><strong>解决重复消费问题:发送者发送消息的时候带着key(特殊业务逻辑字段)，创建去重表(添加业务逻辑字段,创建唯一索引),消费者消费时先插入数据库该字段,索引重复报错,收集异常,并返回给broker消费成功,但是不执行后续业务逻辑,无报错则执行后续业务逻辑,try...catch...后续逻辑,如果业务报错,删除去重表中的数据</strong></p> <p><strong>幂等性</strong> <strong>多次操作产生的影响均和第一次操作产生的额影响相同</strong> <strong>新增,主键自增,无唯一索引,是非幂等的,即每次操作都不一样,有唯一索引,对相同唯一索引的数据新增，是幂等的</strong> <strong>修改:</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>对于 <span class="token keyword">update</span> <span class="token keyword">table</span> <span class="token keyword">set</span> m <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> 是幂等的<span class="token punctuation">,</span>
<span class="token keyword">update</span> <span class="token keyword">table</span> <span class="token keyword">set</span> m <span class="token operator">=</span> m<span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> 是非幂等的<span class="token punctuation">,</span>
每次结果不同
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>查询/删除:是幂等操作</strong> <strong>幂等解决</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">(</span>设置mysql唯一索引可以解决幂等<span class="token operator">/</span><span class="token function">redis</span><span class="token punctuation">(</span>setnx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_21-2-解决方案"><a href="#_21-2-解决方案" class="header-anchor">#</a> 21.2 解决方案</h3> <p>使用去重方案解决，例如将消息的唯一标识存起来，然后每次消费之前先判断是否存在这个唯一标识，如果存在则不消费，如果不存在则消费，并且消费以后将这个标记保存。</p> <p>想法很好，但是消息的体量是非常大的，可能在生产环境中会到达上千万甚至上亿条，那么我们该如何选择一个容器来保存所有消息的标识，并且又可以快速的判断是否存在呢？</p> <p>我们可以选择布隆过滤器(BloomFilter)</p> <p><strong>布隆过滤器（Bloom
Filter）是1970年由布隆提出的。它实际上是一个很长的二进制向量和一系列随机映射函数。布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都比一般的算法要好的多，缺点是有一定的误识别率和删除困难。</strong></p> <p><strong>在hutool的工具中我们可以直接使用，当然你自己使用redis的bitmap类型手写一个也是可以的
<a href="https://hutool.cn/docs/#/bloomFilter/%E6%A6%82%E8%BF%B0" target="_blank" rel="noopener noreferrer">https://hutool.cn/docs/#/bloomFilter/概述<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></p> <p><img src="/assets/img/image33.b944aa67.png" alt=""></p> <h3 id="_21-3-测试生产者"><a href="#_21-3-测试生产者" class="header-anchor">#</a> 21.3 测试生产者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRepeatProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认的生产者</span>
    <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;test-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动实例</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 我们可以使用自定义key当做唯一标识</span>
    <span class="token class-name">String</span> keyId <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>keyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tagA&quot;</span><span class="token punctuation">,</span> keyId<span class="token punctuation">,</span> <span class="token string">&quot;我是一个测试消息&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SendResult</span> send <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭实例</span>
    producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_21-4-添加hutool的依赖"><a href="#_21-4-添加hutool的依赖" class="header-anchor">#</a> 21.4 添加hutool的依赖</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.hutool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hutool-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.7.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_21-5-测试消费者"><a href="#_21-5-测试消费者" class="header-anchor">#</a> 21.5 测试消费者</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 在boot项目中可以使用@Bean在整个容器中放置一个单利对象
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BitMapBloomFilter</span> bloomFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BitMapBloomFilter</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRepeatConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建默认消费者组</span>
    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">BROADCASTING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置nameServer地址</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅一个主题来消费   表达式，默认是*</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册一个消费监听 MessageListenerConcurrently是并发消费</span>
    <span class="token comment">// 默认是20个线程一起消费，可以参看 consumer.setConsumeThreadMax()</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                        <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 拿到消息的key</span>
            <span class="token class-name">MessageExt</span> messageExt <span class="token operator">=</span> msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> keys <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 判断是否存在布隆过滤器中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 直接返回了 不往下处理业务</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 这个处理业务，然后放入过滤器中</span>
            <span class="token comment">// do sth...</span>
            bloomFilter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="_22-rocketmq集成springboot"><a href="#_22-rocketmq集成springboot" class="header-anchor">#</a> 22 Rocketmq集成SpringBoot</h2> <h3 id="_22-1-搭建rocketmq-producer-消息生产者"><a href="#_22-1-搭建rocketmq-producer-消息生产者" class="header-anchor">#</a> 22.1 搭建rocketmq-producer（消息生产者）</h3> <p><img src="/assets/img/image34.552a32c7.png" alt=""></p> <p><img src="/assets/img/image35.f63b6fc6.png" alt=""></p> <h4 id="_22-1-1-创建项目-完整的pom-xml"><a href="#_22-1-1-创建项目-完整的pom-xml" class="header-anchor">#</a> 22.1.1 创建项目，完整的pom.xml</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.powernode<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>01-rocketmq-producer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>rocketmq-producer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Demo project for Spring Boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- rocketmq的依赖 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h4 id="_22-1-2-修改配置文件application-yml"><a href="#_22-1-2-修改配置文件application-yml" class="header-anchor">#</a> 22.1.2 修改配置文件application.yml</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>producer
<span class="token key atrule">rocketmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">name-server</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">9876</span>     <span class="token comment"># rocketMq的nameServer地址</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> powernode<span class="token punctuation">-</span>group        <span class="token comment"># 生产者组别</span>
        <span class="token key atrule">send-message-timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>  <span class="token comment"># 消息发送的超时时间</span>
        <span class="token key atrule">retry-times-when-send-async-failed</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token comment"># 异步消息发送失败重试次数</span>
        <span class="token key atrule">max-message-size</span><span class="token punctuation">:</span> <span class="token number">4194304</span>       <span class="token comment"># 消息的最大长度</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_22-1-3-我们在测试类里面测试发送消息"><a href="#_22-1-3-我们在测试类里面测试发送消息" class="header-anchor">#</a> 22.1.3 我们在测试类里面测试发送消息</h4> <p>往powernode主题里面发送一个简单的字符串消息</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 注入rocketMQTemplate，我们使用它来操作mq
 */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span>

<span class="token comment">/**
 * 测试发送简单的消息
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 往powernode的主题里面发送一个简单的字符串消息</span>
    <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是一个简单的消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拿到消息的发送状态</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拿到消息的id</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>运行后查看控制台</p> <p><img src="/assets/img/image36.3f59f3fb.png" alt=""></p> <h4 id="_22-1-4-查看rocketmq的控制台"><a href="#_22-1-4-查看rocketmq的控制台" class="header-anchor">#</a> 22.1.4 查看rocketMq的控制台</h4> <p><img src="/assets/img/image37.47b31168.png" alt=""></p> <p>查看消息细节</p> <p><img src="/assets/img/image38.99f7d2e1.png" alt=""></p> <h3 id="_22-2-搭建rocketmq-consumer-消息消费者"><a href="#_22-2-搭建rocketmq-consumer-消息消费者" class="header-anchor">#</a> 22.2 搭建rocketmq-consumer（消息消费者）</h3> <p><img src="/assets/img/image39.9e97828b.png" alt=""></p> <p><img src="/assets/img/image40.c9a5b606.png" alt=""></p> <h4 id="_22-2-1-创建项目-完整的pom-xml"><a href="#_22-2-1-创建项目-完整的pom-xml" class="header-anchor">#</a> 22.2.1 创建项目，完整的pom.xml</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.powernode<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>02-rocketmq-consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>rocketmq-consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Demo project for Spring Boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- rocketmq的依赖 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h4 id="_22-2-2-修改配置文件application-yml"><a href="#_22-2-2-修改配置文件application-yml" class="header-anchor">#</a> 22.2.2 修改配置文件application.yml</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>consumer
<span class="token key atrule">rocketmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">name-server</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">9876</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_22-2-3-添加一个监听的类simplemsglistener"><a href="#_22-2-3-添加一个监听的类simplemsglistener" class="header-anchor">#</a> 22.2.3 添加一个监听的类SimpleMsgListener</h4> <p>消费者要消费消息，就添加一个监听</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>powernode<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">MessageModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 创建一个简单消息的监听
 * 1.类上添加注解@Component和@RocketMQMessageListener
 *      @RocketMQMessageListener(topic = &quot;powernode&quot;, consumerGroup = &quot;powernode-group&quot;)
 *      topic指定消费的主题，consumerGroup指定消费组,一个主题可以有多个消费者组,一个消息可以被多个不同的组的消费者都消费
 * 2.实现RocketMQListener接口，注意泛型的使用，可以为具体的类型，如果想拿到消息
 * 的其他参数可以写成MessageExt
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">&quot;powernode-group&quot;</span><span class="token punctuation">,</span>messageModel <span class="token operator">=</span> <span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">CLUSTERING</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleMsgListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 消费消息的方法
     *
     * @param message
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="_22-2-4-启动rocketmq-consumer"><a href="#_22-2-4-启动rocketmq-consumer" class="header-anchor">#</a> 22.2.4 启动rocketmq-consumer</h4> <p>查看控制台，发现我们已经监听到消息了</p> <p><img src="/assets/img/image41.3486640e.png" alt=""></p> <h2 id="_23-rocketmq发送对象消息和集合消息"><a href="#_23-rocketmq发送对象消息和集合消息" class="header-anchor">#</a> 23 RocketMQ发送对象消息和集合消息</h2> <p>我们接着在上面项目里面做</p> <h3 id="_23-1-发送对象消息"><a href="#_23-1-发送对象消息" class="header-anchor">#</a> 23.1 发送对象消息</h3> <p>主要是监听的时候泛型中写对象的类型即可</p> <h4 id="_23-1-1-修改rocketmq-producer添加一个order类"><a href="#_23-1-1-修改rocketmq-producer添加一个order类" class="header-anchor">#</a> 23.1.1 修改rocketmq-producer添加一个Order类</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>powernode<span class="token punctuation">.</span>domain</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 订单对象
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 订单号
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 订单名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 订单价格
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> price<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 订单号创建时间
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
        <span class="token comment">/**
     * 订单描述
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h4 id="_23-1-2-修改rocketmq-producer添加一个单元测试"><a href="#_23-1-2-修改rocketmq-producer添加一个单元测试" class="header-anchor">#</a> 23.1.2 修改rocketmq-producer添加一个单元测试</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试发送对象消息
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testObjectMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderName</span><span class="token punctuation">(</span><span class="token string">&quot;我的订单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">998D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">&quot;加急配送&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 往powernode-obj主题发送一个订单对象</span>
    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">&quot;powernode-obj&quot;</span><span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_23-1-3-发送此消息"><a href="#_23-1-3-发送此消息" class="header-anchor">#</a> 23.1.3 发送此消息</h4> <h4 id="_23-1-4-修改rocketmq-consumer也添加一个order类-拷贝过来"><a href="#_23-1-4-修改rocketmq-consumer也添加一个order类-拷贝过来" class="header-anchor">#</a> 23.1.4 修改rocketmq-consumer也添加一个Order类（拷贝过来）</h4> <h4 id="_23-1-5-修改rocketmq-consumer添加一个objmsglistener"><a href="#_23-1-5-修改rocketmq-consumer添加一个objmsglistener" class="header-anchor">#</a> 23.1.5 修改rocketmq-consumer添加一个ObjMsgListener</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>powernode<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>powernode<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 创建一个对象消息的监听
 * 1.类上添加注解@Component和@RocketMQMessageListener
 * 2.实现RocketMQListener接口，注意泛型的使用
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;powernode-obj&quot;</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">&quot;powernode-obj-group&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjMsgListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 消费消息的方法
     *
     * @param message
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Order</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_23-1-6-重启rocketmq-consumer后查看控制台"><a href="#_23-1-6-重启rocketmq-consumer后查看控制台" class="header-anchor">#</a> 23.1.6 重启rocketmq-consumer后查看控制台</h4> <p>对象消息已经监听到了</p> <p><img src="/assets/img/image42.d34d2821.png" alt=""></p> <h3 id="_23-2-发送集合消息"><a href="#_23-2-发送集合消息" class="header-anchor">#</a> 23.2 发送集合消息</h3> <p>和对象消息同理，创建一个Order的集合，发送出去，监听方注意修改泛型中的类型为Object即可，这里就不做重复演示了</p> <p><img src="/assets/img/image43.2de9495d.png" alt=""></p> <h2 id="_24-rocketmq集成springboot发送不同消息模式"><a href="#_24-rocketmq集成springboot发送不同消息模式" class="header-anchor">#</a> 24 RocketMQ集成SpringBoot发送不同消息模式</h2> <h3 id="_24-1-发送同步消息"><a href="#_24-1-发送同步消息" class="header-anchor">#</a> 24.1 发送同步消息</h3> <p>理解为：消息由消费者发送到broker后，会得到一个确认，是具有可靠性的</p> <p>这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知等。</p> <p>我们在上面的快速入门中演示的消息，就是同步消息，即</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

rocketMQTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

rocketMQTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这三种发送消息的方法，底层都是调用syncSend，发送的是同步消息</p> <h3 id="_24-2-发送异步消息"><a href="#_24-2-发送异步消息" class="header-anchor">#</a> 24.2 发送异步消息</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>rocketMQTemplate<span class="token punctuation">.</span><span class="token function">asyncSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_24-2-1-修改rocketmq-producer添加一个单元测试"><a href="#_24-2-1-修改rocketmq-producer添加一个单元测试" class="header-anchor">#</a> 24.2.1 修改rocketmq-producer添加一个单元测试</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试异步发送消息
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAsyncSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发送异步消息，发送完以后会有一个异步通知</span>
    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">asyncSend</span><span class="token punctuation">(</span><span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;发送一个异步消息&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 成功的回调
         * @param sendResult
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 失败的回调
         * @param throwable
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 测试一下异步的效果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;谁先执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 挂起jvm 不让方法结束</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h4 id="_24-2-2-运行查看控制台效果"><a href="#_24-2-2-运行查看控制台效果" class="header-anchor">#</a> 24.2.2 运行查看控制台效果</h4> <p>谁先发送打印在前面</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATQAAABQCAIAAAAY8R4wAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAGzElEQVR4nO3dXXKkLBQG4ONXc5uFRKyspiHLAZcTcDOpEnM5e+gN+F2gtj+gtDqRVN7namL7N1X9NopHyO73OwFAev67+gQAwA/hBEgUwgmQKIQTIFEIJ0CiEE6ARP0hor9//159GgAwl93v95eXl6tPAwDmcFkLkCiEEyBRvzeclchEdfVJAIQdCKcRmTC+pVm33IisUHZ1H5XIRutYVWSbmwxHWazoXRg8MDdkNNIJ6dofTmPMMn5WlYaYlJyIbJ5zWxa+BA9rK0Psxtnuk9ipEtwQN62+UfeTEBYbd4Cz3e/3djfNiYiYrN2ftWSjv4YlxLV368Xqy+3XDjxfMXbr+KMAXOlYONu2loxxqeu27aO6bpRTE7H6YzszOWwwnIHfgQfDl3sDSBF9fn6es6dZK9ovCjVRvpBst2muJZ5gUi8Xjj4d721yUMMRUkjZSb21VhXhW0uP7qZP3548DlMua6PY14q7hfOWcxHkSnDT32iiRwiStzOcRgwdJsKQVe+lJc6jr1MrvSuaB9102yXTRZPJ+rtPASDeznC6Bqprm2zTEJO15kRky1HXpzCzBX3X5ygm52ma2G7Vrt2uFaNKZNvQYQtXOOOylnFd18pdQ27cc9aKUTgQRWnnaY7JiBH9k1Vieb51tlYV3BBxcSNyPxML8/vh/j8H8J2uqBCaB8LdLJrg3+GMGJFlQuWylo2riMjZRowqUZRoBuFHSKF876uxxPLX6PW70iRbFoa3rVaMMVW73mJTrlyBWlVk3HDj6fIFSE8C4bR1Q5QXUYExIssyw/sL5tGTVWMMEed5WWSBmiRrKjt01gIk7+xwxnUITUQ1nFYVWSYqrlt/sUOXTa3bVnMjpsdxN6VM1Ugm/CCnPedUXY9MRIfQcsvD9bVdNjmR60muFSPGxp1DjcWtJvwsZ4TTqqJo2DPFeKNN30vL5Mdmd+jX2nMSI8RQbu87iG0iuooAEnM8nEYU1a2Oqauds6ooSuueN46xIidq6snbLnVDoWvfLprLgOc5I9s01DQ25hkLQGIO1NZ2vZ5DxVxMQPuaO7dpqI7W15/qv2B2awb249bSknlelVkpq8VrK5CEQ+HUnI2LWdfq3Efc2yg7a84fPwBM1tuH7FafvqviC+f8FRmUxMPlss/Pz7e3t53N7pQRmWhkjXoagDP8OXFfXLftibsD+N0SKEIAAB+EEyBRCCdAohBOgEQhnACJQjgBEnVNOL3jgflHkLeqwCgh8CudGs75dApVYH4Eayo7f62LrG1cmex0j++ltZWJTWf3Zln3r+dSHTpbgGscC2clsmw0HdBXY8evTdtXabh7n3M6ZZAbuMCWk+aTqVrzaTyNKErLdtYc8Q/j3rzG6JfwQx0tfB9VtoYKxgODrGtOixHaNWdM6tW9bZ/S+FC1ZP0+QqOTdKuj3B0ScyCci8w9PdOBllLXdTA1U6PcPDWRw2LrwFspCCckZn84dySEIr/9W++amPDnKx8NJuHc/GXA+ylwkf33nPMBLuPazeReWeknePC1p/t+fwDOcVZvrRsKSMqIAbTG82E+NcFKjNeckW2+hr/RBQs/1lkDfJlqdbD2cYdt11btGdhkfMT5sbwRrHR0+ldHKQL4fueEsypLy6Tk/ts9wyk4ABBNJkUKDqm5bGYnR3pcf07GH+qmK9oePmzY+omhrQH+sXNG33OjWyrBPfUCbtRMroIJWc53G+gQimprH9e1mweeqLTxDm2NvMJVTginazY/FKOblFS+Ty8vq7K0kTejPWNcyxm6IV0MET9e0Ded3bSEsfMM2roZJjeaLAO4yuFwVoKb4cqRqQ9JZTHcXroZvZ65sBwPQmtWOnPCDdprzsiWhastWo+mm+5MVN1PyCybABc7Nu2857Hi42H++jB7vgKh2WCb/gE0l888pmex3Mpw/3PNSe3Q8joaZQlwqTPL9waj/pnwV3sWzj40iztQd6cZiNpj02FJf/DHKt3nZr6jrf/G1vi2AP/U7nCGm5VJzU34u/0I58YI0/0ao9m0uWmnJQL9YbrGWk5Obq1qyB3bf5ZPlyMCnGlnOAPf9z4v03Hdvd/vruv12avGjcq9x4ePZAUbwLXTa5FNuNrBe87e0IqFEzt7fWUYsN13Kbt6HG9evA35cFa+abI9TeaiXA/RhAsdDudwr7jxPX5EVM9qFeJLheJDDPDznTkdAwCcCAN8ASQK4QRIFMIJkCiEEyBRCCdAohBOgEQhnACJQjgBEoVwAiQK4QRIFMIJkCiEEyBRCCdAohBOgEQhnACJQjgBEoVwAiQK4QRIFMIJkCiEEyBRCCdAohBOgET9DwnQTnxz1jyOAAAAAElFTkSuQmCC" alt=""></p> <h3 id="_24-3-发送单向消息"><a href="#_24-3-发送单向消息" class="header-anchor">#</a> 24.3 发送单向消息</h3> <p>这种方式主要用在不关心发送结果的场景，这种方式吞吐量很大，但是存在消息丢失的风险，例如日志信息的发送</p> <h4 id="_24-3-1-修改rocketmq-producer添加一个单元测试"><a href="#_24-3-1-修改rocketmq-producer添加一个单元测试" class="header-anchor">#</a> 24.3.1 修改rocketmq-producer添加一个单元测试</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试单向消息
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testOnWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发送单向消息，没有返回值和结果</span>
    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">sendOneWay</span><span class="token punctuation">(</span><span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;这是一个单向消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_24-4-发送延迟消息"><a href="#_24-4-发送延迟消息" class="header-anchor">#</a> 24.4 发送延迟消息</h3> <h4 id="_24-4-1-修改rocketmq-producer添加一个单元测试"><a href="#_24-4-1-修改rocketmq-producer添加一个单元测试" class="header-anchor">#</a> 24.4.1 修改rocketmq-producer添加一个单元测试</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试延迟消息
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构建消息对象</span>
    <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span><span class="token string">&quot;我是一个延迟消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送一个延时消息，延迟等级为4级，也就是30s后被监听消费</span>
    <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_24-4-2-运行后-查看消费者端-过了30s才被消费"><a href="#_24-4-2-运行后-查看消费者端-过了30s才被消费" class="header-anchor">#</a> 24.4.2 运行后，查看消费者端，过了30s才被消费</h4> <p>这里注意的是RocketMQ不支持任意时间的延时</p> <p>只支持以下几个固定的延时等级，等级1就对应1s，以此类推，最高支持2h延迟</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private String messageDelayLevel = &quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_24-5-发送顺序消息"><a href="#_24-5-发送顺序消息" class="header-anchor">#</a> 24.5 发送顺序消息</h3> <h4 id="_24-5-1-修改order表添加一个顺序字段"><a href="#_24-5-1-修改order表添加一个顺序字段" class="header-anchor">#</a> 24.5.1 修改Order表添加一个顺序字段</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 订单的流程顺序
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Integer</span> seq<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_24-5-2-修改rocketmq-producer添加一个单元测试"><a href="#_24-5-2-修改rocketmq-producer添加一个单元测试" class="header-anchor">#</a> 24.5.2 修改rocketmq-producer添加一个单元测试</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试顺序消费
 * mq会根据hash的值来存放到一个队列里面去
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orders <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;张三的下订单&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;张三的发短信&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;张三的物流&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;张三的签收&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;李四的下订单&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;李四的发短信&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;李四的物流&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;李四的签收&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 我们控制流程为 下订单-&gt;发短信-&gt;物流-&gt;签收  hash的值为seq，也就是说 seq相同的会放在同一个队列里面，顺序消费</span>
    orders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>order <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSendOrderly</span><span class="token punctuation">(</span><span class="token string">&quot;powernode-obj&quot;</span><span class="token punctuation">,</span> order<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="_24-5-3-发送消息"><a href="#_24-5-3-发送消息" class="header-anchor">#</a> 24.5.3 发送消息</h4> <h4 id="_24-5-4-修改rocketmq-consumer的objmsglistener"><a href="#_24-5-4-修改rocketmq-consumer的objmsglistener" class="header-anchor">#</a> 24.5.4 修改rocketmq-consumer的ObjMsgListener</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>powernode<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>powernode<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ConsumeMode</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @Author 武汉动力节点
 * 创建一个对象消息的监听
 * 1.类上添加注解@Component和@RocketMQMessageListener
 * 2.实现RocketMQListener接口，注意泛型的使用
 * consumeMode 指定消费类型
 *      CONCURRENTLY 并发消费
 *      ORDERLY 顺序消费 messages orderly. one queue, one thread
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;powernode-obj&quot;</span><span class="token punctuation">,</span>
        consumerGroup <span class="token operator">=</span> <span class="token string">&quot;powernode-obj-group&quot;</span><span class="token punctuation">,</span>
        consumeMode <span class="token operator">=</span> <span class="token class-name">ConsumeMode</span><span class="token punctuation">.</span><span class="token constant">ORDERLY</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjMsgListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 消费消息的方法
     *
     * @param message
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Order</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h4 id="_24-5-5-重启rocketmq-consumer"><a href="#_24-5-5-重启rocketmq-consumer" class="header-anchor">#</a> 24.5.5 重启rocketmq-consumer</h4> <p>查看控制台，消息按照我们的放入顺序进行消费了</p> <p><img src="/assets/img/image45.b67ded31.png" alt=""></p> <h3 id="_24-6-发送事务消息"><a href="#_24-6-发送事务消息" class="header-anchor">#</a> 24.6 发送事务消息</h3> <h4 id="_24-6-1-修改rocketmq-producer添加一个单元测试"><a href="#_24-6-1-修改rocketmq-producer添加一个单元测试" class="header-anchor">#</a> 24.6.1 修改rocketmq-producer添加一个单元测试</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试事务消息
 * 默认是sync（同步的）
 * 事务消息会有确认和回查机制
 * 事务消息都会走到同一个监听回调里面，所以我们需要使用tag或者key来区分过滤
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构建消息体</span>
    <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span><span class="token string">&quot;这是一个事务消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送事务消息（同步的） 最后一个参数才是消息主题</span>
    <span class="token class-name">TransactionSendResult</span> transaction <span class="token operator">=</span> rocketMQTemplate<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token string">&quot;消息的参数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拿到本地事务状态</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span><span class="token function">getLocalTransactionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 挂起jvm，因为事务的回查需要一些时间</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_24-6-2-修改rocketmq-producer添加一个本地事务消息的监听-半消息"><a href="#_24-6-2-修改rocketmq-producer添加一个本地事务消息的监听-半消息" class="header-anchor">#</a> 24.6.2 修改rocketmq-producer添加一个本地事务消息的监听（半消息）</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 事务消息的监听与回查
 * 类上添加注解@RocketMQTransactionListener 表示这个类是本地事务消息的监听类
 * 实现RocketMQLocalTransactionListener接口
 * 两个方法为执行本地事务，与回查本地事务
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQTransactionListener</span><span class="token punctuation">(</span>corePoolSize <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>maximumPoolSize <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TmMsgListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQLocalTransactionListener</span> <span class="token punctuation">{</span>
 <span class="token comment">/**
     * 执行本地事务，这里可以执行一些业务
     * 比如操作数据库，操作成功就return RocketMQLocalTransactionState.COMMIT;
     * 可以使用try catch来控制成功或者失败;
     * @param msg
     * @param arg
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 拿到消息参数</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拿到消息头</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回状态COMMIT,UNKNOWN</span>
        <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 回查本地事务，只有上面的执行方法返回UNKNOWN时，才执行下面的方法 默认是1min回查
     * 此方法为回查方法，执行需要等待一会
     * xxx.isSuccess()  这里可以执行一些检查的方法
     * 如果返回COMMIT，那么本地事务就算是提交成功了，消息就会被消费者看到
     *
     * @param msg
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h4 id="_24-6-3-测试发送事务-建议断点启动"><a href="#_24-6-3-测试发送事务-建议断点启动" class="header-anchor">#</a> 24.6.3 测试发送事务，建议断点启动</h4> <ol><li><p>消息会先到事务监听类的执行方法，</p></li> <li><p>如果返回状态为COMMIT，则消费者可以直接监听到</p></li> <li><p>如果返回状态为ROLLBACK，则消息发送失败，直接回滚</p></li> <li><p>如果返回状态为UNKNOW，则过一会会走回查方法</p></li> <li><p>如果回查方法返回状态为UNKNOW或者ROLLBACK，则消息发送失败，直接回滚</p></li> <li><p>如果回查方法返回状态为COMMIT，则消费者可以直接监听到</p></li></ol> <h2 id="_25-rocketmq集成springboot的消息过滤"><a href="#_25-rocketmq集成springboot的消息过滤" class="header-anchor">#</a> 25 RocketMQ集成SpringBoot的消息过滤</h2> <h3 id="_25-1-tag过滤-常在消费者端过滤"><a href="#_25-1-tag过滤-常在消费者端过滤" class="header-anchor">#</a> 25.1 tag过滤（常在消费者端过滤）</h3> <p>我们从源码注释得知，tag带在主题后面用：来携带，感谢注释</p> <p><img src="/assets/img/image46.f33423b0.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>我们往下去看源码，在org.apache.rocketmq.spring.support.RocketMQUtil的getAndWrapMessage方法里面看到了具体细节，我们也知道了keys在消息头里面携带
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image47.5f6e39ea.png" alt=""></p> <h4 id="_25-1-1-修改rocketmq-producer添加一个单元测试"><a href="#_25-1-1-修改rocketmq-producer添加一个单元测试" class="header-anchor">#</a> 25.1.1 修改rocketmq-producer添加一个单元测试</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 发送一个带tag的消息
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTagMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发送一个tag为java的数据</span>
    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">&quot;powernode-tag:java&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是一个带tag的消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_25-1-2-发送消息"><a href="#_25-1-2-发送消息" class="header-anchor">#</a> 25.1.2 发送消息</h4> <h4 id="_25-1-3-修改rocketmq-consumer添加一个tagmsglistener"><a href="#_25-1-3-修改rocketmq-consumer添加一个tagmsglistener" class="header-anchor">#</a> 25.1.3 修改rocketmq-consumer添加一个TagMsgListener</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>powernode<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">SelectorType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @Author 武汉动力节点
 * 创建一个简单的标签消息的监听
 * 1.类上添加注解@Component和@RocketMQMessageListener
 *      selectorType = SelectorType.TAG,  指定使用tag过滤。(也可以使用sql92 需要在配置文件broker.conf中开启enbalePropertyFilter=true)
 *      selectorExpression = &quot;java&quot;     表达式，默认是*,支持&quot;tag1 || tag2 || tag3&quot;
 * 2.实现RocketMQListener接口，注意泛型的使用
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;powernode-tag&quot;</span><span class="token punctuation">,</span>
        consumerGroup <span class="token operator">=</span> <span class="token string">&quot;powernode-tag-group&quot;</span><span class="token punctuation">,</span>
        selectorType <span class="token operator">=</span> <span class="token class-name">SelectorType</span><span class="token punctuation">.</span><span class="token constant">TAG</span><span class="token punctuation">,</span>
        selectorExpression <span class="token operator">=</span> <span class="token string">&quot;java&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TagMsgListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 消费消息的方法
     *
     * @param message
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="_25-1-4-重启rocketmq-consumer查看控制台"><a href="#_25-1-4-重启rocketmq-consumer查看控制台" class="header-anchor">#</a> 25.1.4 重启rocketmq-consumer查看控制台</h4> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAcsAAAAuCAIAAADInqWVAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAG+ElEQVR4nO2dS5KjOBCGk4m+SC9tKfoAc4XZIuo4iOMUqe1cYfYdobR3VXeoPgCzkMGIl23KKj/q/xYdwUMgyc1PKvWjyj4+Pt7f33/+/Ekgpv73v1tX4TEo/vn71lUA4E758f7+TkThXwBWgP88AMyRvb29/fnz59evX7euCQAAPBt/3boCAADwtEBhAQAgFVBYIiJXZFmWFe7W9QAAPBdpFFaszjJtJcnFr44rDBMRsT2rxmJ1T40HTXXFbRsuVk++K+b2B7jICo7O7W2Of8349DGuwPsKACK6msKGIDDLxvKyIDnhqT9N2mfVFYZJlZ4NSVU9tiyIfalElb7OhwfYCRke7T+Uqpi4OFNExeqCiav514irmVRZTt4LgG/G29vb79+/m0vxpYouY7g94H3TNGyIVOmbxnt/OFWVfuoaXcH52yyf8ilC3Q5VY0NzN2OzsnvHrU7ZkLm7Tx+NGluHFpq6vxm2fKnaSx0u1J51efd8VX8AcB+sjWGV7Z6U+PFVKnqYlVLK+qZhI5W+t4GjK3QlZNhbRUSU175UbKYi7rwnKbHq9+SnaXqvlvawPXaHWK2TBuTR26Gneq6qaKBsodrbzbFs3fhSqZ3wYbO/1bWAnajSt3IccVo7V7+mAHhYfnzRffK6aSYPsMmyE2W3168OEbkiM0yGm97QWVnPu8xoTb4vjVdivxNJ1JglXGHYcHO6Ocp6b2e2un3NcF+LVDqrTt/j5BkAPBMJvQSy259x1hlZggRVszozrErfjDKTeR3i7fnpKmV9cyynrO9Hqnkdx603R6xlMsVCUnQ4sUVcxHlwXUkQ0Cg5PszSIoYFYMxKhe3PUelKQijawzCN9k3PhH05YnWmKzE8q4R53fiSqnhE74qJxpw3SdcWHXdK1BnibKG7ftW6cMOeEleM5waXO3TPTlRZ+PkMjbAT4mKgmUt6mei1B8ATslZh/eCBG4Sig+xk/8hA1iZl+Cgf1VX1+KiuUfA6Npcp6xtf7ky8+6Jpmgt1SOyLqVi6m4mwiWRRrNaGL+2OjfWNN94JmxmNDSG5oaGb4FKGQe4Ys+TwAuApSZQlUHqYb3TF9CTPZVmCdZFklmVZ4VyR6WrLTTNODUy3wfqm8bnTi8JzhvW3nSYbexWi183WlHycPmRDRFx3XeaqSnoaH47TQiQet4QNjTV2q9uipm5qQyb/xDgeWQIAJljp1hqqoOGjGqrSDwLbw7N1r1ad+Yj7qmUX3GAnzw6d2y8c33jZrTWu55INbsopMCIybA0dFPMtutf/AgCk4VMxbPhkoM3DvtBruKa3KgSxXLt2VinIbgi31gaiN0/hTn0kMTkNtKqu4npp2OGYOgwKuG4vKyGmPUahRPNuLSIiZV9LJdXLmfW6PA+LLAEAY1YqbBDJoKldDBsNVzdbFZKswXLaP5rXi8/ubJR3L3P08UB/HMOuGQ0fsqzz8peXpSLiVsa0YaJlj8AQZe3CZ2v82c99kSUAYMxKhQ0iuSR5yuTh4HFaSewopfn9vmDf+SkVa7Osx0TsUI9cVUn/cw5lprxmy+Rlqcx2I0S030n0wQEzE23VylfYyKMmduLbirtzsgGQnHQrvxxsAL0wa7+T2CQr1k58wT7pLngGFd5sFZE4HrmwWrZ6E/RHnC1sNKZ2NRMZ+/rq28RrvUKrlPW1nZJRkR2R2h6nJ5fG/LHBwxVtUqS/BIXJDZvxz+Y+51cA4NG4tsJ2qVnDYQR9nMEWv4sEV+xLJUTiBhakySzBhdHaXRJyqVKZo+m1VZvNVhERmy4HUA065ZB00bqfqp3yzK5C2Amp3By199w87GHdnNeB3Ctl68aXql2u7LAemaNtSZV+jhcmAGdwBYVtB5zBtxT8UEESW5dQeKD2O+kJbNBXU5YqhEvf4ZnLa89mciSurPdlJ3BKGfYcL/dg7cGP0R+LDz2zZyN+15smGwvsmczoa1fndnIz3GC7yXNrfcPm3IUiAXh41rq1ognlZQtSl1HsAqPOzDl1sXlSLbJ1vuNqPBXXlY3acG1TUmvW8vHOYzeedGtFsKGh06t3an3CVTV7fOlnhE0LfEtWr/yytAjIgMGqL67IDI9WXDn3YrdloaJJ27DfCRGRJ8nbxVNE9jumaIGsqFNdkZlduyFWDz6P61YUCwEmTcfWc+XNZBb4YX5GAL4K/K3Zh2CskAdUmWIVMADAdcDf6XoIlPWeTbT2rlKmZMgrAHcNYlgAAEgFYlgAAEgFFBYAAFIBhQUAgFRAYQEAIBVQWAAASAUUFgAAUgGFBQCAVEBhAQAgFVBYAABIBRQWAABSAYUFAIBUQGEBACAVUFgAAEgFFBYAAFIBhQUAgFRAYQEAIBVQWAAASAUUFgAAUgGFBQCAVPwPg1VI/9ZDeOgAAAAASUVORK5CYII=" alt=""></p> <h3 id="_25-2-key过滤-可以在事务监听的类里面区分"><a href="#_25-2-key过滤-可以在事务监听的类里面区分" class="header-anchor">#</a> 25.2 Key过滤（可以在事务监听的类里面区分）</h3> <h4 id="_25-2-1-修改rocketmq-producer添加一个单元测试"><a href="#_25-2-1-修改rocketmq-producer添加一个单元测试" class="header-anchor">#</a> 25.2.1 修改rocketmq-producer添加一个单元测试</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 发送一个带key的消息,我们使用事务消息 打断点查看消息头
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testKeyMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发送一个key为spring的事务消息</span>
    <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span><span class="token string">&quot;我是一个带key的消息&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">RocketMQHeaders</span><span class="token punctuation">.</span><span class="token constant">KEYS</span><span class="token punctuation">,</span> <span class="token string">&quot;spring&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token string">&quot;我是一个带key的消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_25-2-2-断点发送这个消息-查看事务里面消息头"><a href="#_25-2-2-断点发送这个消息-查看事务里面消息头" class="header-anchor">#</a> 25.2.2 断点发送这个消息，查看事务里面消息头</h4> <p><img src="/assets/img/image49.15dbdafd.png" alt=""></p> <p>我们在mq的控制台也可以看到</p> <p><img src="/assets/img/image50.13206a67.png" alt=""></p> <h2 id="_26-rocketmq集成springboot消息消费两种模式"><a href="#_26-rocketmq集成springboot消息消费两种模式" class="header-anchor">#</a> 26 RocketMQ集成SpringBoot消息消费两种模式</h2> <p>Rocketmq消息消费的模式分为两种：<strong>负载均衡模式和广播模式</strong></p> <p>负载均衡模式表示多个消费者交替消费同一个主题里面的消息</p> <p>广播模式表示每个每个消费者都消费一遍订阅的主题的消息</p> <h3 id="_26-1-再搭建一个消费者rocketmq-consumer-b-依赖和配置文件和rocketmq-consumer一致-记住端口修改一下-避免占用"><a href="#_26-1-再搭建一个消费者rocketmq-consumer-b-依赖和配置文件和rocketmq-consumer一致-记住端口修改一下-避免占用" class="header-anchor">#</a> 26.1 再搭建一个消费者rocketmq-consumer-b，依赖和配置文件和rocketmq-consumer一致，记住端口修改一下，避免占用</h3> <h3 id="_26-2-rocketmq-consumer-b添加一个监听"><a href="#_26-2-rocketmq-consumer-b添加一个监听" class="header-anchor">#</a> 26.2 rocketmq-consumer-b添加一个监听</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>powernode<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">MessageModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * messageModel  指定消息消费的模式
 *      CLUSTERING 为负载均衡模式
 *      BROADCASTING 为广播模式
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span>
        consumerGroup <span class="token operator">=</span> <span class="token string">&quot;powernode-group&quot;</span><span class="token punctuation">,</span>
        messageModel <span class="token operator">=</span> <span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">CLUSTERING</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerBListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_26-3-修改rocketmq-consumer的simplemsglistener"><a href="#_26-3-修改rocketmq-consumer的simplemsglistener" class="header-anchor">#</a> 26.3 修改rocketmq-consumer的SimpleMsgListener</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 创建一个简单消息的监听
 * 1.类上添加注解@Component和@RocketMQMessageListener
 *
 * @RocketMQMessageListener(topic = &quot;powernode&quot;, consumerGroup = &quot;powernode-group&quot;)
 * topic指定消费的主题，consumerGroup指定消费组,一个主题可以有多个消费者组,一个消息可以被多个不同的组的消费者都消费
 * 2.实现RocketMQListener接口，注意泛型的使用
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> 
        consumerGroup <span class="token operator">=</span> <span class="token string">&quot;powernode-group&quot;</span><span class="token punctuation">,</span>
        messageModel <span class="token operator">=</span> <span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">CLUSTERING</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleMsgListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_26-4-启动两个消费者"><a href="#_26-4-启动两个消费者" class="header-anchor">#</a> 26.4 启动两个消费者</h3> <h3 id="_26-5-在生产者里面添加一个单元测试并且运行"><a href="#_26-5-在生产者里面添加一个单元测试并且运行" class="header-anchor">#</a> 26.5 在生产者里面添加一个单元测试并且运行</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试消息消费的模式
 *
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMsgModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">&quot;powernode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;我是消息&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_26-6-查看两个消费者的控制台-发现是负载均衡的模式"><a href="#_26-6-查看两个消费者的控制台-发现是负载均衡的模式" class="header-anchor">#</a> 26.6 查看两个消费者的控制台，发现是负载均衡的模式</h3> <p><img src="/assets/img/image51.67f1aa7e.png" alt=""></p> <p><img src="/assets/img/image52.669397a2.png" alt=""></p> <h3 id="_26-7-修改两个消费者的模式为broadcasting"><a href="#_26-7-修改两个消费者的模式为broadcasting" class="header-anchor">#</a> 26.7 修改两个消费者的模式为BROADCASTING</h3> <p>重启测试，结果是广播模式，每个消费者都消费了这些消息</p> <p>项目中 一般部署多态机器 消费者 2 - 3 根据业务可以选择具体的模式来配置</p> <p><strong>重置消费点位, 将一个组的消费节点 设置在之前的某一个时间点上去
从这个时间点开始往后消费</strong></p> <p><strong>跳过堆积 选择一个组 跳过堆积以后 这个组里面的的所有都不会被消费了</strong></p> <h2 id="_27-如何解决消息堆积问题"><a href="#_27-如何解决消息堆积问题" class="header-anchor">#</a> 27 如何解决消息堆积问题？</h2> <p>一般认为单条队列消息差值&gt;=10w时 算堆积问题</p> <h3 id="_27-1-什么情况下会出现堆积"><a href="#_27-1-什么情况下会出现堆积" class="header-anchor">#</a> 27.1 什么情况下会出现堆积</h3> <ol><li><p>生产太快了</p> <p>生产方可以做业务限流</p> <p>1、增加消费者数量,但是消费者数量&lt;=队列数量, 适当的设置最大的消费线程数量(根据IO(2n)/CPU(n+1))
2、(运维在控制台)动态扩容队列数量,从而增加消费者数量</p></li> <li><p>消费者消费出现问题</p> <p>排查消费者程序的问题</p></li></ol> <h2 id="_28-如何确保消息不丢失"><a href="#_28-如何确保消息不丢失" class="header-anchor">#</a> 28 如何确保消息不丢失？</h2> <p><strong>数据库创建消息记录表，根据消息id或者key(业务id)创建表.添加status字段，生产者生产时添加数据,消费者消费之后将数据状态修改为已经修复</strong></p> <ol><li><p>生产者使用同步发送模式 ，收到mq的返回确认以后
顺便往自己的数据库里面写</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>msgId status(0) time
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>消费者消费以后 修改数据这条消息的状态 = 1</p></li> <li><p>写一个定时任务 间隔两天去查询数据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> 如果有status = 0 and time &lt; day-2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>将mq的刷盘机制设置为同步刷盘</p></li> <li><p>使用集群模式 ，搞主备模式，将消息持久化在不同的硬件上</p></li> <li><p>可以开启mq的trace机制，消息跟踪机制</p> <p>1.在broker.conf中开启消息追踪</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>traceTopicEnable=true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2.重启broker即可</p> <p>3.生产者配置文件开启消息轨迹</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>enable-msg-trace: true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>4.消费者开启消息轨迹功能，可以给单独的某一个消费者开启</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>enableMsgTrace = true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在rocketmq的面板中可以查看消息轨迹</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>默认会将消息轨迹的数据存在 RMQ_SYS_TRACE_TOPIC 主题里面
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <h2 id="_29-安全"><a href="#_29-安全" class="header-anchor">#</a> 29 安全</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>1.  开启acl的控制 在broker.conf中开启aclEnable=true

2.  配置账号密码 修改plain_acl.yml

3.  修改控制面板的配置文件 放开52/53行 把49行改为true上传到服务器的jar包平级目录下即可

java配置文件中：
 rockketmq:
    name-server:***
    consumer:
        access-key:
        secret-key:
        
//修改控制台的配置文件,application.properties开启登录，会读取user.properties配置文件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2024/6/16</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/中间件/rocketMq/RocketMQ.html" class="prev">
          RocketMQ入门
        </a></span> <span class="next"><a href="/中间件/rocketMq/mq/mq.html">
          首页
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">RocketMQ深入理解</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#主要内容" class="toc-sidebar-link">主要内容</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_1-rocketmq简介" class="toc-sidebar-link">1 RocketMQ简介</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_2-为什么要使用mq" class="toc-sidebar-link">2 为什么要使用MQ</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_2-1-定义" class="toc-sidebar-link">2.1 定义</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_2-2-特点" class="toc-sidebar-link">2.2 特点</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_3-各个mq产品的比较" class="toc-sidebar-link">3 各个MQ产品的比较</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_4-rocketmq重要概念【重点】" class="toc-sidebar-link">4 RocketMQ重要概念【重点】</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_5-生产和消费理解【重点】" class="toc-sidebar-link">5 生产和消费理解【重点】</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-rocketmq安装" class="toc-sidebar-link">6 RocketMQ安装</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-1-下载rocketmq" class="toc-sidebar-link">6.1 下载RocketMQ</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-2-上传服务器" class="toc-sidebar-link">6.2 上传服务器</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-3-解压" class="toc-sidebar-link">6.3 解压</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-4-配置环境变量" class="toc-sidebar-link">6.4 配置环境变量</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-5-修改nameserver的运行脚本" class="toc-sidebar-link">6.5 修改nameServer的运行脚本</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#修改broker的运行脚本" class="toc-sidebar-link">修改broker的运行脚本</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-6-修改broker的配置文件" class="toc-sidebar-link">6.6 修改broker的配置文件</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-7-启动" class="toc-sidebar-link">6.7 启动</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-8-rocketmq控制台的安装rocketmq-console" class="toc-sidebar-link">6.8 RocketMQ控制台的安装RocketMQ-Console</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-9-阿里云放行-nameserver-9876-broker-10100-11000" class="toc-sidebar-link">6.9  阿里云放行  nameServer 9876    broker 10100 - 11000</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-rocketmq安装之docker" class="toc-sidebar-link">7 RocketMQ安装之docker</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-1-下载rockermq需要的镜像" class="toc-sidebar-link">7.1 下载RockerMQ需要的镜像</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-2-启动nameserver服务" class="toc-sidebar-link">7.2 启动NameServer服务</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-3-启动broker服务" class="toc-sidebar-link">7.3 启动Broker服务</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-4-启动控制台" class="toc-sidebar-link">7.4 启动控制台</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-5-正常启动后的docker-ps" class="toc-sidebar-link">7.5 正常启动后的docker ps</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-6-访问控制台" class="toc-sidebar-link">7.6 访问控制台</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_8-rocketmq快速入门" class="toc-sidebar-link">8 RocketMQ快速入门</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_8-1-消息发送和监听的流程" class="toc-sidebar-link">8.1 消息发送和监听的流程</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_8-2-搭建rocketmq-demo" class="toc-sidebar-link">8.2 搭建Rocketmq-demo</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_9-消费模式" class="toc-sidebar-link">9 消费模式</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_10-rocketmq发送同步消息" class="toc-sidebar-link">10 RocketMQ发送同步消息</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_11-rocketmq发送异步消息" class="toc-sidebar-link">11 RocketMQ发送异步消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_11-1-异步消息生产者" class="toc-sidebar-link">11.1 异步消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_11-2-异步消息消费者" class="toc-sidebar-link">11.2 异步消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_12-rocketmq发送单向消息" class="toc-sidebar-link">12 RocketMQ发送单向消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_12-1-单向消息生产者" class="toc-sidebar-link">12.1 单向消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_12-2-单向消息消费者" class="toc-sidebar-link">12.2 单向消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_13-rocketmq发送延迟消息" class="toc-sidebar-link">13 RocketMQ发送延迟消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_13-1-延迟消息生产者" class="toc-sidebar-link">13.1 延迟消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_13-2-延迟消息消费者" class="toc-sidebar-link">13.2 延迟消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-rocketmq发送顺序消息" class="toc-sidebar-link">14 RocketMQ发送顺序消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-1-场景分析" class="toc-sidebar-link">14.1 场景分析</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-2-创建一个订单对象" class="toc-sidebar-link">14.2 创建一个订单对象</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-3-顺序消息生产者" class="toc-sidebar-link">14.3 顺序消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-4-顺序消息消费者-测试时等一会即可有延迟" class="toc-sidebar-link">14.4 顺序消息消费者，测试时等一会即可有延迟</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_15-rocketmq发送批量消息" class="toc-sidebar-link">15 RocketMQ发送批量消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_15-1-批量消息生产者" class="toc-sidebar-link">15.1 批量消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_15-2-批量消息消费者" class="toc-sidebar-link">15.2 批量消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-rocketmq发送事务消息" class="toc-sidebar-link">16 RocketMQ发送事务消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-1-事务消息的发送流程" class="toc-sidebar-link">16.1 事务消息的发送流程</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-2-事务消息生产者" class="toc-sidebar-link">16.2 事务消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-3-事务消息消费者" class="toc-sidebar-link">16.3 事务消息消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-4-测试结果" class="toc-sidebar-link">16.4 测试结果</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_17-rocketmq发送带标签的消息-消息过滤" class="toc-sidebar-link">17 RocketMQ发送带标签的消息，消息过滤</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_17-1-标签消息生产者" class="toc-sidebar-link">17.1 标签消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_17-2-标签消息消费者" class="toc-sidebar-link">17.2 标签消息消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_17-3-什么时候该用-topic-什么时候该用-tag" class="toc-sidebar-link">17.3 什么时候该用 Topic，什么时候该用 Tag？</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_18-rocketmq中消息的key" class="toc-sidebar-link">18 RocketMQ中消息的Key</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_18-1-带key消息生产者" class="toc-sidebar-link">18.1 带key消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_18-2-带key消息消费者" class="toc-sidebar-link">18.2 带key消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_19-rocketmq重试机制" class="toc-sidebar-link">19 RocketMQ重试机制</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_19-1-生产者重试" class="toc-sidebar-link">19.1 生产者重试</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_19-2-消费者重试" class="toc-sidebar-link">19.2 消费者重试</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-rocketmq死信消息" class="toc-sidebar-link">20 RocketMQ死信消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-1-消息生产者" class="toc-sidebar-link">20.1 消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-2-消息消费者" class="toc-sidebar-link">20.2 消息消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-3-死信消费者" class="toc-sidebar-link">20.3 死信消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-4-控制台显示" class="toc-sidebar-link">20.4 控制台显示</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-rocketmq消息重复消费问题" class="toc-sidebar-link">21 RocketMQ消息重复消费问题</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-1-为什么会出现重复消费问题呢" class="toc-sidebar-link">21.1 为什么会出现重复消费问题呢？</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-2-解决方案" class="toc-sidebar-link">21.2 解决方案</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-3-测试生产者" class="toc-sidebar-link">21.3 测试生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-4-添加hutool的依赖" class="toc-sidebar-link">21.4 添加hutool的依赖</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-5-测试消费者" class="toc-sidebar-link">21.5 测试消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_22-rocketmq集成springboot" class="toc-sidebar-link">22 Rocketmq集成SpringBoot</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_22-1-搭建rocketmq-producer-消息生产者" class="toc-sidebar-link">22.1 搭建rocketmq-producer（消息生产者）</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_22-2-搭建rocketmq-consumer-消息消费者" class="toc-sidebar-link">22.2 搭建rocketmq-consumer（消息消费者）</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_23-rocketmq发送对象消息和集合消息" class="toc-sidebar-link">23 RocketMQ发送对象消息和集合消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_23-1-发送对象消息" class="toc-sidebar-link">23.1 发送对象消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_23-2-发送集合消息" class="toc-sidebar-link">23.2 发送集合消息</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-rocketmq集成springboot发送不同消息模式" class="toc-sidebar-link">24 RocketMQ集成SpringBoot发送不同消息模式</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-1-发送同步消息" class="toc-sidebar-link">24.1 发送同步消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-2-发送异步消息" class="toc-sidebar-link">24.2 发送异步消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-3-发送单向消息" class="toc-sidebar-link">24.3 发送单向消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-4-发送延迟消息" class="toc-sidebar-link">24.4 发送延迟消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-5-发送顺序消息" class="toc-sidebar-link">24.5 发送顺序消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-6-发送事务消息" class="toc-sidebar-link">24.6 发送事务消息</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_25-rocketmq集成springboot的消息过滤" class="toc-sidebar-link">25 RocketMQ集成SpringBoot的消息过滤</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_25-1-tag过滤-常在消费者端过滤" class="toc-sidebar-link">25.1 tag过滤（常在消费者端过滤）</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_25-2-key过滤-可以在事务监听的类里面区分" class="toc-sidebar-link">25.2 Key过滤（可以在事务监听的类里面区分）</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-rocketmq集成springboot消息消费两种模式" class="toc-sidebar-link">26 RocketMQ集成SpringBoot消息消费两种模式</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-1-再搭建一个消费者rocketmq-consumer-b-依赖和配置文件和rocketmq-consumer一致-记住端口修改一下-避免占用" class="toc-sidebar-link">26.1 再搭建一个消费者rocketmq-consumer-b，依赖和配置文件和rocketmq-consumer一致，记住端口修改一下，避免占用</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-2-rocketmq-consumer-b添加一个监听" class="toc-sidebar-link">26.2 rocketmq-consumer-b添加一个监听</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-3-修改rocketmq-consumer的simplemsglistener" class="toc-sidebar-link">26.3 修改rocketmq-consumer的SimpleMsgListener</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-4-启动两个消费者" class="toc-sidebar-link">26.4 启动两个消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-5-在生产者里面添加一个单元测试并且运行" class="toc-sidebar-link">26.5 在生产者里面添加一个单元测试并且运行</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-6-查看两个消费者的控制台-发现是负载均衡的模式" class="toc-sidebar-link">26.6 查看两个消费者的控制台，发现是负载均衡的模式</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-7-修改两个消费者的模式为broadcasting" class="toc-sidebar-link">26.7 修改两个消费者的模式为BROADCASTING</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_27-如何解决消息堆积问题" class="toc-sidebar-link">27 如何解决消息堆积问题？</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_27-1-什么情况下会出现堆积" class="toc-sidebar-link">27.1 什么情况下会出现堆积</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_28-如何确保消息不丢失" class="toc-sidebar-link">28 如何确保消息不丢失？</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_29-安全" class="toc-sidebar-link">29 安全</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">RocketMQ深入理解</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#主要内容" class="toc-sidebar-link">主要内容</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_1-rocketmq简介" class="toc-sidebar-link">1 RocketMQ简介</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_2-为什么要使用mq" class="toc-sidebar-link">2 为什么要使用MQ</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_2-1-定义" class="toc-sidebar-link">2.1 定义</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_2-2-特点" class="toc-sidebar-link">2.2 特点</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_3-各个mq产品的比较" class="toc-sidebar-link">3 各个MQ产品的比较</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_4-rocketmq重要概念【重点】" class="toc-sidebar-link">4 RocketMQ重要概念【重点】</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_5-生产和消费理解【重点】" class="toc-sidebar-link">5 生产和消费理解【重点】</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-rocketmq安装" class="toc-sidebar-link">6 RocketMQ安装</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-1-下载rocketmq" class="toc-sidebar-link">6.1 下载RocketMQ</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-2-上传服务器" class="toc-sidebar-link">6.2 上传服务器</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-3-解压" class="toc-sidebar-link">6.3 解压</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-4-配置环境变量" class="toc-sidebar-link">6.4 配置环境变量</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-5-修改nameserver的运行脚本" class="toc-sidebar-link">6.5 修改nameServer的运行脚本</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#修改broker的运行脚本" class="toc-sidebar-link">修改broker的运行脚本</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-6-修改broker的配置文件" class="toc-sidebar-link">6.6 修改broker的配置文件</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-7-启动" class="toc-sidebar-link">6.7 启动</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-8-rocketmq控制台的安装rocketmq-console" class="toc-sidebar-link">6.8 RocketMQ控制台的安装RocketMQ-Console</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_6-9-阿里云放行-nameserver-9876-broker-10100-11000" class="toc-sidebar-link">6.9  阿里云放行  nameServer 9876    broker 10100 - 11000</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-rocketmq安装之docker" class="toc-sidebar-link">7 RocketMQ安装之docker</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-1-下载rockermq需要的镜像" class="toc-sidebar-link">7.1 下载RockerMQ需要的镜像</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-2-启动nameserver服务" class="toc-sidebar-link">7.2 启动NameServer服务</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-3-启动broker服务" class="toc-sidebar-link">7.3 启动Broker服务</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-4-启动控制台" class="toc-sidebar-link">7.4 启动控制台</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-5-正常启动后的docker-ps" class="toc-sidebar-link">7.5 正常启动后的docker ps</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_7-6-访问控制台" class="toc-sidebar-link">7.6 访问控制台</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_8-rocketmq快速入门" class="toc-sidebar-link">8 RocketMQ快速入门</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_8-1-消息发送和监听的流程" class="toc-sidebar-link">8.1 消息发送和监听的流程</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_8-2-搭建rocketmq-demo" class="toc-sidebar-link">8.2 搭建Rocketmq-demo</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_9-消费模式" class="toc-sidebar-link">9 消费模式</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_10-rocketmq发送同步消息" class="toc-sidebar-link">10 RocketMQ发送同步消息</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_11-rocketmq发送异步消息" class="toc-sidebar-link">11 RocketMQ发送异步消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_11-1-异步消息生产者" class="toc-sidebar-link">11.1 异步消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_11-2-异步消息消费者" class="toc-sidebar-link">11.2 异步消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_12-rocketmq发送单向消息" class="toc-sidebar-link">12 RocketMQ发送单向消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_12-1-单向消息生产者" class="toc-sidebar-link">12.1 单向消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_12-2-单向消息消费者" class="toc-sidebar-link">12.2 单向消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_13-rocketmq发送延迟消息" class="toc-sidebar-link">13 RocketMQ发送延迟消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_13-1-延迟消息生产者" class="toc-sidebar-link">13.1 延迟消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_13-2-延迟消息消费者" class="toc-sidebar-link">13.2 延迟消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-rocketmq发送顺序消息" class="toc-sidebar-link">14 RocketMQ发送顺序消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-1-场景分析" class="toc-sidebar-link">14.1 场景分析</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-2-创建一个订单对象" class="toc-sidebar-link">14.2 创建一个订单对象</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-3-顺序消息生产者" class="toc-sidebar-link">14.3 顺序消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_14-4-顺序消息消费者-测试时等一会即可有延迟" class="toc-sidebar-link">14.4 顺序消息消费者，测试时等一会即可有延迟</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_15-rocketmq发送批量消息" class="toc-sidebar-link">15 RocketMQ发送批量消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_15-1-批量消息生产者" class="toc-sidebar-link">15.1 批量消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_15-2-批量消息消费者" class="toc-sidebar-link">15.2 批量消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-rocketmq发送事务消息" class="toc-sidebar-link">16 RocketMQ发送事务消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-1-事务消息的发送流程" class="toc-sidebar-link">16.1 事务消息的发送流程</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-2-事务消息生产者" class="toc-sidebar-link">16.2 事务消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-3-事务消息消费者" class="toc-sidebar-link">16.3 事务消息消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_16-4-测试结果" class="toc-sidebar-link">16.4 测试结果</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_17-rocketmq发送带标签的消息-消息过滤" class="toc-sidebar-link">17 RocketMQ发送带标签的消息，消息过滤</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_17-1-标签消息生产者" class="toc-sidebar-link">17.1 标签消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_17-2-标签消息消费者" class="toc-sidebar-link">17.2 标签消息消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_17-3-什么时候该用-topic-什么时候该用-tag" class="toc-sidebar-link">17.3 什么时候该用 Topic，什么时候该用 Tag？</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_18-rocketmq中消息的key" class="toc-sidebar-link">18 RocketMQ中消息的Key</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_18-1-带key消息生产者" class="toc-sidebar-link">18.1 带key消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_18-2-带key消息消费者" class="toc-sidebar-link">18.2 带key消息消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_19-rocketmq重试机制" class="toc-sidebar-link">19 RocketMQ重试机制</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_19-1-生产者重试" class="toc-sidebar-link">19.1 生产者重试</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_19-2-消费者重试" class="toc-sidebar-link">19.2 消费者重试</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-rocketmq死信消息" class="toc-sidebar-link">20 RocketMQ死信消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-1-消息生产者" class="toc-sidebar-link">20.1 消息生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-2-消息消费者" class="toc-sidebar-link">20.2 消息消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-3-死信消费者" class="toc-sidebar-link">20.3 死信消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_20-4-控制台显示" class="toc-sidebar-link">20.4 控制台显示</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-rocketmq消息重复消费问题" class="toc-sidebar-link">21 RocketMQ消息重复消费问题</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-1-为什么会出现重复消费问题呢" class="toc-sidebar-link">21.1 为什么会出现重复消费问题呢？</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-2-解决方案" class="toc-sidebar-link">21.2 解决方案</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-3-测试生产者" class="toc-sidebar-link">21.3 测试生产者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-4-添加hutool的依赖" class="toc-sidebar-link">21.4 添加hutool的依赖</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_21-5-测试消费者" class="toc-sidebar-link">21.5 测试消费者</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_22-rocketmq集成springboot" class="toc-sidebar-link">22 Rocketmq集成SpringBoot</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_22-1-搭建rocketmq-producer-消息生产者" class="toc-sidebar-link">22.1 搭建rocketmq-producer（消息生产者）</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_22-2-搭建rocketmq-consumer-消息消费者" class="toc-sidebar-link">22.2 搭建rocketmq-consumer（消息消费者）</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_23-rocketmq发送对象消息和集合消息" class="toc-sidebar-link">23 RocketMQ发送对象消息和集合消息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_23-1-发送对象消息" class="toc-sidebar-link">23.1 发送对象消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_23-2-发送集合消息" class="toc-sidebar-link">23.2 发送集合消息</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-rocketmq集成springboot发送不同消息模式" class="toc-sidebar-link">24 RocketMQ集成SpringBoot发送不同消息模式</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-1-发送同步消息" class="toc-sidebar-link">24.1 发送同步消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-2-发送异步消息" class="toc-sidebar-link">24.2 发送异步消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-3-发送单向消息" class="toc-sidebar-link">24.3 发送单向消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-4-发送延迟消息" class="toc-sidebar-link">24.4 发送延迟消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-5-发送顺序消息" class="toc-sidebar-link">24.5 发送顺序消息</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_24-6-发送事务消息" class="toc-sidebar-link">24.6 发送事务消息</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_25-rocketmq集成springboot的消息过滤" class="toc-sidebar-link">25 RocketMQ集成SpringBoot的消息过滤</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_25-1-tag过滤-常在消费者端过滤" class="toc-sidebar-link">25.1 tag过滤（常在消费者端过滤）</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_25-2-key过滤-可以在事务监听的类里面区分" class="toc-sidebar-link">25.2 Key过滤（可以在事务监听的类里面区分）</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-rocketmq集成springboot消息消费两种模式" class="toc-sidebar-link">26 RocketMQ集成SpringBoot消息消费两种模式</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-1-再搭建一个消费者rocketmq-consumer-b-依赖和配置文件和rocketmq-consumer一致-记住端口修改一下-避免占用" class="toc-sidebar-link">26.1 再搭建一个消费者rocketmq-consumer-b，依赖和配置文件和rocketmq-consumer一致，记住端口修改一下，避免占用</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-2-rocketmq-consumer-b添加一个监听" class="toc-sidebar-link">26.2 rocketmq-consumer-b添加一个监听</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-3-修改rocketmq-consumer的simplemsglistener" class="toc-sidebar-link">26.3 修改rocketmq-consumer的SimpleMsgListener</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-4-启动两个消费者" class="toc-sidebar-link">26.4 启动两个消费者</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-5-在生产者里面添加一个单元测试并且运行" class="toc-sidebar-link">26.5 在生产者里面添加一个单元测试并且运行</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-6-查看两个消费者的控制台-发现是负载均衡的模式" class="toc-sidebar-link">26.6 查看两个消费者的控制台，发现是负载均衡的模式</a></li><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_26-7-修改两个消费者的模式为broadcasting" class="toc-sidebar-link">26.7 修改两个消费者的模式为BROADCASTING</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_27-如何解决消息堆积问题" class="toc-sidebar-link">27 如何解决消息堆积问题？</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_27-1-什么情况下会出现堆积" class="toc-sidebar-link">27.1 什么情况下会出现堆积</a></li></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_28-如何确保消息不丢失" class="toc-sidebar-link">28 如何确保消息不丢失？</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html#_29-安全" class="toc-sidebar-link">29 安全</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/wechat.png" class="nozoom"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">微信扫一扫</span> <img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://tec.hjcwzx.top/%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMq/rocketMq%E6%B7%B1%E5%85%A5.html" style="margin:10px;">
                可以<b>手机看</b>或分享至<b>朋友圈</b></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/xingqiu.png" width="25px" class="nozoom"> <span class="show-txt">星球</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><img height="180px" src="/images/personal/xingqiu.png" style="margin:10px;"> <b>知识星球</b>：技术侦探
            </div></div></div></div> <div class="option-box"><img src="/images/system/wexin4.png" width="25px" class="nozoom"> <span class="show-txt">交流</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">添加微信一起学习交流</span> <img src="/images/personal/weixin.png" height="180px" style="margin:10px;">
                PS：添加时请备注<b>技术侦探</b>，谢谢！
              </div></div></div></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">支持我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/encourage-head.png" style="margin:5px;"> <br>1. 不靠它生存但仍希望得到你的鼓励；
                <br>2. 时刻警醒自己保持技术人的初心，沉淀，分享，成长；
              </div></div></div></div> <div title="RocketMQ入门" class="option-box" style="padding-left:2px;text-align:center;"><a href="/中间件/rocketMq/RocketMQ.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="首页" class="option-box" style="padding-left:2px;text-align:center;"><a href="/中间件/rocketMq/mq/mq.html"><img src="/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div>  <div class="page-side-sitemap"><div class="option-box"><img src="/images/system/sitemap.png" class="nozoom img"> <span class="show-txt">站点图</span> <div class="sitemap-container"><h4>站点导航图
              <a href="/更新日志/更新日志.html" class="sitemap-top-link"> 更新日志</a></h4> <table class="sitemap-table"><tr><td nowrap="nowrap"><div class="sitemap-col-group">常用搜索</div></td> <td><div class="sitemap-col-item"><a href="http://www.baidu.com/" target="_blank" title="百度">
          百度
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.google.com/" target="_blank" title="Google">
          Google
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.bing.com/" target="_blank" title="Bing">
          Bing
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://github.com" target="_blank" title="Github">
          Github
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.programcreek.com/java-api-examples/index.php" target="_blank" title="搜代码">
          搜代码
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></td> <!----></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">技术社区</div></td> <td><div class="sitemap-col-item"><a href="http://www.csdn.net/" target="_blank" title="CDSN">
          CDSN
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.cnblogs.com/" target="_blank" title="博客园">
          博客园
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.oschina.net" target="_blank" title="OSChina">
          OSChina
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://segmentfault.com/" target="_blank" title="思否">
          思否
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://juejin.im" target="_blank" title="掘金">
          掘金
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.linuxidc.com/" target="_blank" title="Linux公社">
          Linux公社
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.ibm.com/developerworks/cn/" target="_blank" title="IBM 开发者">
          IBM 开发者
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://stackoverflow.com" target="_blank" title="StackOverflow">
          StackOverflow
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></td> <!----></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">Java相关</div></td> <!----> <td><a href="/java/javaSE基础/01_Java入门与开发环境搭建.html" class="sitemap-col-item">
          JavaSE基础
        </a><a href="/java/JavaSE高级/01_IO.html" class="sitemap-col-item">
          JavaSE高级
        </a><a href="/java/javaWeb/01_Web开发基础.html" class="sitemap-col-item">
          JavaWeb
        </a><a href="/java/JUC/1、JUC概述.html" class="sitemap-col-item">
          JUC
        </a><a href="/java/补充/JVM.html" class="sitemap-col-item">
          JVM
        </a><a href="/java/补充/枚举.html" class="sitemap-col-item">
          ENUM
        </a><a href="/java/补充/线程池.html" class="sitemap-col-item">
          线程池
        </a><a href="/java/补充/自定义注解.html" class="sitemap-col-item">
          自定义注解
        </a><a href="/java/响应式编程/前置知识.html" class="sitemap-col-item">
          响应式编程
        </a></td></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">Spring</div></td> <!----> <td><a href="/框架/Mybatis/01_MyBatis快速入门.html" class="sitemap-col-item">
          Mybatis
        </a><a href="/框架/Mybatis/03_MybatisPlus.html" class="sitemap-col-item">
          Mybatis Plus
        </a><a href="/框架/Spring全家桶/Spring/01_SpringIOC和DI.html" class="sitemap-col-item">
          Spring
        </a><a href="/框架/Spring全家桶/SpringMVC/01_SpringMVC快速入门及解析.html" class="sitemap-col-item">
          Spring MVC
        </a><a href="/框架/Spring全家桶/SpringBoot/01_SpringBoot_入门.html" class="sitemap-col-item">
          Spring Boot
        </a><a href="/框架/Spring全家桶/SpringCloudAlibaba/Nacos.html" class="sitemap-col-item">
          Spring Cloud Alibaba
        </a></td></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">中间件&amp;插件</div></td> <!----> <td><a href="/中间件/maven/01_Maven基础.html" class="sitemap-col-item">
          Maven中央仓库
        </a><a href="/中间件/ElasticSearch/ElasticSearch.html" class="sitemap-col-item">
          ElasticSearch
        </a><a href="/中间件/redis/Redis笔记全.html" class="sitemap-col-item">
          Redis
        </a><a href="/中间件/redis/布隆过滤器.html" class="sitemap-col-item">
          布隆过滤器
        </a><a href="/中间件/rocketMq/RocketMQ.html" class="sitemap-col-item">
          RocketMQ.
        </a><a href="/中间件/git/笔记.html" class="sitemap-col-item">
          git
        </a><a href="/中间件/自定义Starter/自定义starter.html" class="sitemap-col-item">
          自定义starter
        </a></td></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">运维</div></td> <!----> <td><a href="/部署/nginx/Nginx.html" class="sitemap-col-item">
          Nginx
        </a><a href="/部署/docker/docker.html" class="sitemap-col-item">
          Docker
        </a><a href="/部署/linux/01_Linux_安装.html" class="sitemap-col-item">
          Linux
        </a><a href="/部署/vm/linux安装centos.html" class="sitemap-col-item">
          VM Ware
        </a></td></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">面向对象</div></td> <!----> <td><a href="/设计模式/创建型模式/" class="sitemap-col-item">
          设计模式
        </a></td></tr></table></div></div></div> <!----> </aside></div><div class="global-ui"><div class="read-more-wrap" style="display:none;position:absolute;bottom:0px;z-index:9999;width:100%;margin-top:-100px;font-family:PingFangSC-Regular, sans-serif;"><div id="read-more-mask" style="position: relative; height: 200px; background: -webkit-gradient(linear, 0 0%, 0 100%, from(rgba(255, 255, 255, 0)), to(rgb(255, 255, 255)));"></div> <a id="read-more-btn" target="_self" style="position: absolute; left: 50%; top: 70%; bottom: 30px;\n        transform: translate(-50%, -50%); width: 160px; height: 36px;\n         line-height: 36px; font-size: 15px; text-align: center;\n          border: 1px solid rgb(222, 104, 109); color: rgb(222, 104, 109);\n           background: rgb(255, 255, 255); cursor: pointer; border-radius: 6px;">阅读全文</a> <div id="btw-modal-wrap" style="display: none;"><div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0);"></div> <div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;"><span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 34px; font-size: 34px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">×</span> <p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px;">
            微信扫码或搜索：<span style="color: #E9405A; font-weight: bold;">智慧对话的未来</span> <br>发送：<span id="hutec-token" class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">}</span> <br>即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章</p> <img src="/images/personal/qrcode.png" style="width: 180px; margin-top: 10px; margin-bottom: 30px; border: 8px solid rgb(230, 230, 230);"></div></div></div></div></div>
    <script src="/assets/js/cg-styles.js?v=1720663609756" defer></script><script src="/assets/js/cg-4.js?v=1720663609756" defer></script><script src="/assets/js/cg-13.js?v=1720663609756" defer></script><script src="/assets/js/cg-1.js?v=1720663609756" defer></script><script src="/assets/js/cg-92.js?v=1720663609756" defer></script><script src="/assets/js/cg-app.js?v=1720663609756" defer></script>
  </body>
</html>
